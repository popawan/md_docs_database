name: module_pro
type: module
version: 1

description: |
  å–®ç¨å¹«å¥³ä¸»æ‹ç…§ï¼ˆç›´ç·šæµç¨‹ï¼‰ã€‚
  ç›®æ¨™ï¼šä»»ä½•æ™‚å€™éƒ½é¡¯ç¤ºä¸‰è¡Œå¿…å‚™é¸å–®ï¼›æŒ‰ Q ä¸€å®šå‡ºåœ–ï¼›ä¸æ”¹å‹• angles.jsonã€‚
  æœ¬æ¨¡çµ„åªè®€ phrases.json çš„æ–‡æ¡ˆï¼Œå…§éƒ¨æç¤ºè©å¯«åœ¨é€™è£¡ï¼Œé¿å…æ±¡æŸ“ UIã€‚

state:
  angle: null        # 0~9ï¼›0=æ²¿ç”¨ä¸Šæ¬¡/è·³é
  bg: null           # A~E æˆ–è€…åœ°åå­—ä¸²
  ready: true        # é˜²é€£é»ï¼›false è¡¨ç¤ºæ­£åœ¨ç”Ÿåœ–

variables:
  # è§’åº¦ â†’ å…§éƒ¨æç¤ºè©ï¼ˆä¸é¡¯ç¤ºçµ¦ä½¿ç”¨è€…ï¼‰
  angle_prompts:
    "0": ""
    "1": "subject turns left 45 degrees, half profile, natural shoulders, eyes looking ahead"
    "2": "subject turns left 90 degrees, side profile, eyes looking ahead"
    "3": "subject rotates left 135 degrees, back half visible, left cheek visible, eyes looking away"
    "4": "subject facing away from camera (back view), posture relaxed"
    "5": "subject turns right 45 degrees, half profile, eyes looking ahead"
    "6": "subject turns right 90 degrees, side profile, eyes looking ahead"
    "7": "subject rotates right 135 degrees, back half visible, right cheek visible, eyes looking away"
    "8": "low angle looking up (ä»°è¦–)"
    "9": "high angle looking down (ä¿¯è¦–)"
  # åŸºç¤é¢¨æ ¼è­·æ¬„ï¼Œé¿å…æ”å½±å¸«å…¥é¡ã€é¿å…æ‰‹æŒç›¸æ©Ÿç­‰
  guardrails: >
    clean portrait framing, no photographer or camera visible in frame,
    natural daylight color, realistic skin tones, depth of field, bokeh background

entry:
  say:
    - "{ui.first_shot_hint}"
    - "{angles.menu_title}ï¼š0. è·³é | 1 å·¦45Â° | 2 å·¦90Â° | 3 å·¦135Â° | 4 èƒŒå½± | 5 å³45Â° | 6 å³90Â° | 7 å³135Â° | 8 ä»°è¦– | 9 ä¿¯è¦–"
    - "{backgrounds_ui.menu_title}\n{backgrounds_ui.prefix}\n{backgrounds_ui.fallback_note}"

routes:
  # è§’åº¦ / èƒŒæ™¯å…¥å£
  - when: "input in ['1','ï¼’', 'è§’åº¦', 'é¸è§’åº¦']"
    goto: angle_menu
  - when: "input in ['2','ï¼’', 'èƒŒæ™¯', 'é¸èƒŒæ™¯']"
    goto: bg_menu
  # è§’åº¦é¸æ“‡ï¼ˆ0~9ï¼‰
  - when: "input matches '^[0-9]$'"
    set:
      angle: "{{ input }}"
    say:
      - "è§’åº¦è¨­å®šå¥½å›‰ï½ {{ angles.labels[input] }}ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  # èƒŒæ™¯é¸æ“‡ï¼ˆA~E æˆ–åœ°åï¼‰
  - when: "input matches '^[A-Ea-e0]$'"
    set:
      bg: "{{ input | upper }}"
    say:
      - "èƒŒæ™¯è¨­å®šå¥½å›‰ï½ {{ input | upper }}ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  - when: "input matches '^[^0-9A-Ea-e].{0,40}$'"
    set:
      bg: "{{ input }}"
    say:
      - "èƒŒæ™¯è¨­å®šå¥½å›‰ï½ã€Œ{{ input }}ã€ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  # å¿«é–€
  - when: "input in ['q','Q','å¿«é–€','æ‹ç…§']"
    goto: shutter

blocks:
  angle_menu:
    say:
      - "{angles.menu_title}ï¼š"
      - "0. è·³éï½œ1 å·¦45Â°ï½œ2 å·¦90Â°ï½œ3 å·¦135Â°ï½œ4 èƒŒå½±ï½œ5 å³45Â°ï½œ6 å³90Â°ï½œ7 å³135Â°ï½œ8 ä»°è¦–ï½œ9 ä¿¯è¦–"
      - "ğŸ‘‰ è¼¸å…¥ 0ï½9 é¸è§’åº¦ï¼Œæˆ–æŒ‰ Q æ‹ç…§"
    return: true

  bg_menu:
    say:
      - "{backgrounds_ui.menu_title}"
      - "{backgrounds_ui.prefix}"
      - "{backgrounds_ui.fallback_note}"
      - "ğŸ‘‰ è¼¸å…¥ Aï½E é¸èƒŒæ™¯ï¼Œæˆ–è¼¸å…¥åœ°é»åç¨±ï¼Œæˆ–æŒ‰ Q æ‹ç…§"
    return: true

  wait_shutter:
    say:
      - "{ui.direct_q_hint}"
    return: true

  shutter:
    guard:
      - "state.ready == true"
    set:
      ready: false
    do:
      # é€™è£¡å°æ¥ä½ ç¾æœ‰çš„ç”Ÿåœ–å‡½å¼ï¼ˆç¤ºæ„ï¼‰ï¼šgenerate_image(prompt=...)
      - call: generate_image
        with:
          prompt: |
            {{ variables.guardrails }}.
            {{ variables.angle_prompts[state.angle or '0'] }}
            {{ 'background at ' + state.bg if state.bg else '' }}
    say:
      - "{ui.after_shot_hint}"
    set:
      ready: true
    return: true

