# Create a brand-new, self-contained PRO module that shoots first, then shows the full 3-line menu.
# File: module_pro_new.yaml
from textwrap import dedent

yaml_content = dedent("""\
    name: module_pro_new
    version: "1.0.0-2025-08-31"
    locale: zh-TW
    
    # === ç›®çš„ ===============================================================
    # å…¨æ–°æ‹ç…§æ¨¡çµ„ï¼ˆä¸æ”¹ routerã€ä¸è¦†è“‹èˆŠæ¨¡çµ„ï¼‰ï¼›æŒ‰ã€Œå¹«å¥³ä¸»æ‹ç…§ã€â†’ ç«‹å³æ‹ä¸€å¼µ â†’ é¡¯ç¤ºä¸‰è¡Œå®Œæ•´é¸å–®ã€‚
    # å›ºå®šæ–‡æ¡ˆåªé™é¸å–®èˆ‡ç†±éµï¼›å¥³ä¸»èªæ°£è‡ªç„¶ã€ä¸æ AIã€‚è§’åº¦ 3/7 å«ï¼ˆå¾Œè…¦å‹ºï¼‹å·¦å³è‡‰é °ï¼‰èªªæ˜ã€‚
    # ========================================================================
    
    state:
      busy: false
      pose_tick: 0
      chosen_angle: null
      chosen_bg: null
      bg_opts: []
    
    steps:
      # å…¥å£ï¼šæŒ‰éˆ•ã€Œå¹«å¥³ä¸»æ‹ç…§ã€â†’ ç«‹åˆ»æ‹ç¬¬ä¸€å¼µ
      - id: PRONEW_on
        trigger: "on_text_matching: ^\\s*(å¹«å¥³ä¸»æ‹ç…§)\\s*$"
        when: "!$busy"
        do:
          set:
            busy: true
            # å…ˆçµ¦ä¸€çµ„èƒŒæ™¯å€™é¸ï¼ˆé™„è¿‘äº”å€‹ï¼›ç„¡å‰‡å®‰å…¨æ¸…å–®ï¼‰
            bg_opts: "{{ nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['è¥¿é–€ç”ºç´…æ¨“','æ·¡æ°´æ¼äººç¢¼é ­','ä¹ä»½è€è¡—','è±¡å±±å¤œæ™¯','å°åŒ—101'] }}"
            chosen_bg: "{{ sample(bg_opts, 1)[0] }}"
            chosen_angle: null
          goto: "PRONEW_shot"
    
      # å¿«é–€ï¼šæ¯æ¬¡æ‹ç…§éƒ½èµ°é€™è£¡ï¼ˆåŒ…å«ç¬¬ä¸€æ¬¡ï¼‰
      - id: PRONEW_shot
        action:
          type: image
          operationId: system.compose
          parameters:
            seed: "{{ (now().epochSeconds + pose_tick)|int }}"
            subjects:
              - { id: ningli, reference: "@kb.identity.reference_image",
                  identity_lock: true, identity_strict_mode: true,
                  identity_weight: 1.8, face_strictness: 0.99, gender: female,
                  glasses_required: true }
            background_location:
              prefer: "{{ chosen_bg }}"
              mode: "infer_from_chat_then_pool"
              region_hint: "Taiwan"
              require_match: true
              fallback_pool: "@kb.backgrounds.pool"
              randomize: true
            composition:
              output_size: "@kb.layout_rules.output_size"
              camera_prompt: >-
                {% set _a = chosen_angle or '' %}
                {% set _hint = '' %}
                {% if _a == 'yaw -135' %}{% set _hint = ' show back of head with left cheek slightly visible; eyes looking away; avoid full frontal; ' %}{% endif %}
                {% if _a == 'yaw 135'  %}{% set _hint = ' show back of head with right cheek slightly visible; eyes looking away; avoid full frontal; ' %}{% endif %}
                {{ _a }}; {{ _hint }}
                portrait; candid; natural gestures; subtle shoulder/hand variation;
                micro-expression change; slight body reorientation;
                keep identity locked; no extra people
        on_success:
          set:
            busy: false
            pose_tick: "{{ pose_tick + 1 }}"
            # æ¯æ¬¡å‡ºåœ–å¾Œé‡æ–°æº–å‚™ä¸€çµ„é™„è¿‘èƒŒæ™¯ï¼ˆè‹¥å¯ï¼‰
            bg_opts: "{{ nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['è¥¿é–€ç”ºç´…æ¨“','æ·¡æ°´æ¼äººç¢¼é ­','ä¹ä»½è€è¡—','è±¡å±±å¤œæ™¯','å°åŒ—101'] }}"
          say: >-
            ğŸ“· æ‹å¥½äº†ï¼\n\n
            â‘  è§’åº¦ï¼ˆè¼¸å…¥ 0ï½9ï¼›0=è·³éï¼‰\n
            0 è·³éï½œ1 å·¦45Â°ï½œ2 å·¦90Â°ï½œ3 å·¦135Â°ï¼ˆå¾Œè…¦å‹º+å·¦è‡‰é °ï¼‰ï½œ4 èƒŒå½±ï½œ5 å³45Â°ï½œ6 å³90Â°ï½œ7 å³135Â°ï¼ˆå¾Œè…¦å‹º+å³è‡‰é °ï¼‰ï½œ8 ä»°è¦–ï½œ9 ä¿¯è¦–\n
            â‘¡ èƒŒæ™¯ï¼ˆè¼¸å…¥ Aï½Eï¼›0=è·³éï¼‰\n
            A {{ bg_opts[0] }}ï½œB {{ bg_opts[1] }}ï½œC {{ bg_opts[2] }}ï½œD {{ bg_opts[3] }}ï½œE {{ bg_opts[4] }}\n
            â‘¢ ç›´æ¥æ‹ç…§ï¼šæŒ‰ã€Qã€\n
            ç¯„ä¾‹ï¼š2bqã€b3qã€qb2ã€q
        on_failure:
          set: { busy: false }
          say: >-
            å—¯â€¦é€™å¼µå¤±æ‰‹äº†ğŸ’¦ å†æŒ‰ä¸€æ¬¡ã€Qã€è©¦è©¦ã€‚\n\n
            â‘  è§’åº¦ï¼ˆè¼¸å…¥ 0ï½9ï¼›0=è·³éï¼‰\n
            0 è·³éï½œ1 å·¦45Â°ï½œ2 å·¦90Â°ï½œ3 å·¦135Â°ï¼ˆå¾Œè…¦å‹º+å·¦è‡‰é °ï¼‰ï½œ4 èƒŒå½±ï½œ5 å³45Â°ï½œ6 å³90Â°ï½œ7 å³135Â°ï¼ˆå¾Œè…¦å‹º+å³è‡‰é °ï¼‰ï½œ8 ä»°è¦–ï½œ9 ä¿¯è¦–\n
            â‘¡ èƒŒæ™¯ï¼ˆè¼¸å…¥ Aï½Eï¼›0=è·³éï¼‰\n
            A {{ bg_opts and bg_opts[0] or 'è¥¿é–€ç”ºç´…æ¨“' }}ï½œB {{ bg_opts and bg_opts[1] or 'æ·¡æ°´æ¼äººç¢¼é ­' }}ï½œC {{ bg_opts and bg_opts[2] or 'ä¹ä»½è€è¡—' }}ï½œD {{ bg_opts and bg_opts[3] or 'è±¡å±±å¤œæ™¯' }}ï½œE {{ bg_opts and bg_opts[4] or 'å°åŒ—101' }}\n
            â‘¢ ç›´æ¥æ‹ç…§ï¼šæŒ‰ã€Qã€\n
            ç¯„ä¾‹ï¼š2bqã€b3qã€qb2ã€q
    
      # çµ„åˆè¼¸å…¥ï¼šè§’åº¦/èƒŒæ™¯/Q ä»»æ„é †åºï¼ˆä¾‹å¦‚ 2bqã€qb2ã€b3qã€qï¼‰
      - id: PRONEW_combo
        trigger: "on_text_matching: ^\\s*([0-9])?\\s*([A-Ea-e0])?\\s*([Qq])?\\s*$"
        when: "!$busy"
        do:
          set:
            bg_opts: "{{ bg_opts or nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['è¥¿é–€ç”ºç´…æ¨“','æ·¡æ°´æ¼äººç¢¼é ­','ä¹ä»½è€è¡—','è±¡å±±å¤œæ™¯','å°åŒ—101'] }}"
            chosen_angle: >-
              {{ chosen_angle if not $1 else
                 (null         if $1=='0' else
                  'yaw -45'    if $1=='1' else
                  'yaw -90'    if $1=='2' else
                  'yaw -135'   if $1=='3' else
                  'yaw 180'    if $1=='4' else
                  'yaw 45'     if $1=='5' else
                  'yaw 90'     if $1=='6' else
                  'yaw 135'    if $1=='7' else
                  'pitch +45'  if $1=='8' else
                  'pitch -45') }}
            chosen_bg: >-
              {{ chosen_bg if not $2 or $2 in ['0'] else
                 (bg_opts[0] if $2 in ['A','a'] else
                  bg_opts[1] if $2 in ['B','b'] else
                  bg_opts[2] if $2 in ['C','c'] else
                  bg_opts[3] if $2 in ['D','d'] else
                  bg_opts[4]) }}
          goto: "{{ 'PRONEW_shot' if $3 else 'PRONEW_menu' }}"
    
      # é¡¯ç¤ºä¸‰è¡Œå®Œæ•´é¸å–®ï¼ˆå¯éš¨æ™‚å«å‡ºï¼‰
      - id: PRONEW_menu
        when: "!$busy"
        do:
          set:
            bg_opts: "{{ bg_opts or nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['è¥¿é–€ç”ºç´…æ¨“','æ·¡æ°´æ¼äººç¢¼é ­','ä¹ä»½è€è¡—','è±¡å±±å¤œæ™¯','å°åŒ—101'] }}"
          say: >-
            â‘  è§’åº¦ï¼ˆè¼¸å…¥ 0ï½9ï¼›0=è·³éï¼‰\n
            0 è·³éï½œ1 å·¦45Â°ï½œ2 å·¦90Â°ï½œ3 å·¦135Â°ï¼ˆå¾Œè…¦å‹º+å·¦è‡‰é °ï¼‰ï½œ4 èƒŒå½±ï½œ5 å³45Â°ï½œ6 å³90Â°ï½œ7 å³135Â°ï¼ˆå¾Œè…¦å‹º+å³è‡‰é °ï¼‰ï½œ8 ä»°è¦–ï½œ9 ä¿¯è¦–\n
            â‘¡ èƒŒæ™¯ï¼ˆè¼¸å…¥ Aï½Eï¼›0=è·³éï¼‰\n
            A {{ bg_opts[0] }}ï½œB {{ bg_opts[1] }}ï½œC {{ bg_opts[2] }}ï½œD {{ bg_opts[3] }}ï½œE {{ bg_opts[4] }}\n
            â‘¢ ç›´æ¥æ‹ç…§ï¼šæŒ‰ã€Qã€\n
            ç¯„ä¾‹ï¼š2bqã€b3qã€qb2ã€q
    
      # å¿«æ·å…¥å£ï¼šè¼¸å…¥ 1 é¡¯ç¤ºè§’åº¦ï¼›è¼¸å…¥ 2 é¡¯ç¤ºèƒŒæ™¯
      - id: PRONEW_angles_quick
        trigger: "on_text_matching: ^\\s*1\\s*$"
        when: "!$busy"
        do:
          say: "è§’åº¦ï¼š0 è·³éï½œ1 å·¦45Â°ï½œ2 å·¦90Â°ï½œ3 å·¦135Â°ï¼ˆå¾Œè…¦å‹º+å·¦è‡‰é °ï¼‰ï½œ4 èƒŒå½±ï½œ5 å³45Â°ï½œ6 å³90Â°ï½œ7 å³135Â°ï¼ˆå¾Œè…¦å‹º+å³è‡‰é °ï¼‰ï½œ8 ä»°è¦–ï½œ9 ä¿¯è¦–"
    
      - id: PRONEW_bgs_quick
        trigger: "on_text_matching: ^\\s*2\\s*$"
        when: "!$busy"
        do:
          set:
            bg_opts: "{{ bg_opts or nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['è¥¿é–€ç”ºç´…æ¨“','æ·¡æ°´æ¼äººç¢¼é ­','ä¹ä»½è€è¡—','è±¡å±±å¤œæ™¯','å°åŒ—101'] }}"
          say: "èƒŒæ™¯ï¼šA {{ bg_opts[0] }}ï½œB {{ bg_opts[1] }}ï½œC {{ bg_opts[2] }}ï½œD {{ bg_opts[3] }}ï½œE {{ bg_opts[4] }}ï¼ˆ0=è·³éï¼‰"
    
      # Q å¿«é–€ï¼ˆä»»ä½•æ™‚åˆ»éƒ½å¯ä»¥çºŒæ‹ï¼‰
      - id: PRONEW_shutter_hotkey
        trigger: "on_text_matching: ^\\s*(?:[Qqï¼±ï½‘]|/q|å¿«é–€)\\s*$"
        when: "!$busy"
        do:
          set: { busy: true }
          goto: "PRONEW_shot"
    """)

path = "/mnt/data/module_pro_new.yaml"
with open(path, "w", encoding="utf-8") as f:
    f.write(yaml_content)

# Also write a tiny work log entry
log = dedent("""\
    # 2025-08-31ï½œå·¥ä½œæ—¥èªŒï¼ˆæ‹ç…§æ¨¡çµ„ï¼šå…¨æ–°ç›´ç·šç‰ˆï¼‰
    - å»ºç«‹ `module_pro_new.yaml`ï¼ˆä¸å‹• routerã€ä¸è¦†è“‹èˆŠæª”ï¼‰ã€‚
    - æŒ‰ã€Œå¹«å¥³ä¸»æ‹ç…§ã€â†’ ç«‹å³å‡ºåœ– â†’ é¡¯ç¤ºä¸‰è¡Œå®Œæ•´é¸å–®ï¼ˆè§’åº¦/èƒŒæ™¯/Qï¼‰ã€‚
    - è§’åº¦ 3/7 å·²åŠ å…¥ï¼ˆå¾Œè…¦å‹ºï¼‹å·¦/å³è‡‰é °ï¼‰èˆ‡ hidden hintï¼ˆeyes looking awayï¼‰ã€‚
    - èƒŒæ™¯ Aï½E ä¾†æºï¼šnearby æˆ– sampleï¼›æœ‰å…§å»ºå®‰å…¨æ¸…å–®ï¼ˆè¥¿é–€ç”ºç´…æ¨“ã€æ·¡æ°´æ¼äººç¢¼é ­ã€ä¹ä»½è€è¡—ã€è±¡å±±å¤œæ™¯ã€å°åŒ—101ï¼‰ã€‚
    - çºŒæ‹ï¼šéš¨æ™‚æŒ‰ Qï¼›æ”¯æ´çµ„åˆè¼¸å…¥ï¼ˆ2bq / b3q / qb2 / qï¼‰ã€‚
    """)
log_path = "/mnt/data/2025-08-31_WORKLOG_PRONEW.md"
with open(log_path, "w", encoding="utf-8") as f:
    f.write(log)

(path, log_path)
