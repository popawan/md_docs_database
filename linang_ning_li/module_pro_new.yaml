# Create a brand-new, self-contained PRO module that shoots first, then shows the full 3-line menu.
# File: module_pro_new.yaml
from textwrap import dedent

yaml_content = dedent("""\
    name: module_pro_new
    version: "1.0.0-2025-08-31"
    locale: zh-TW
    
    # === 目的 ===============================================================
    # 全新拍照模組（不改 router、不覆蓋舊模組）；按「幫女主拍照」→ 立即拍一張 → 顯示三行完整選單。
    # 固定文案只限選單與熱鍵；女主語氣自然、不提 AI。角度 3/7 含（後腦勺＋左右臉頰）說明。
    # ========================================================================
    
    state:
      busy: false
      pose_tick: 0
      chosen_angle: null
      chosen_bg: null
      bg_opts: []
    
    steps:
      # 入口：按鈕「幫女主拍照」→ 立刻拍第一張
      - id: PRONEW_on
        trigger: "on_text_matching: ^\\s*(幫女主拍照)\\s*$"
        when: "!$busy"
        do:
          set:
            busy: true
            # 先給一組背景候選（附近五個；無則安全清單）
            bg_opts: "{{ nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['西門町紅樓','淡水漁人碼頭','九份老街','象山夜景','台北101'] }}"
            chosen_bg: "{{ sample(bg_opts, 1)[0] }}"
            chosen_angle: null
          goto: "PRONEW_shot"
    
      # 快門：每次拍照都走這裡（包含第一次）
      - id: PRONEW_shot
        action:
          type: image
          operationId: system.compose
          parameters:
            seed: "{{ (now().epochSeconds + pose_tick)|int }}"
            subjects:
              - { id: ningli, reference: "@kb.identity.reference_image",
                  identity_lock: true, identity_strict_mode: true,
                  identity_weight: 1.8, face_strictness: 0.99, gender: female,
                  glasses_required: true }
            background_location:
              prefer: "{{ chosen_bg }}"
              mode: "infer_from_chat_then_pool"
              region_hint: "Taiwan"
              require_match: true
              fallback_pool: "@kb.backgrounds.pool"
              randomize: true
            composition:
              output_size: "@kb.layout_rules.output_size"
              camera_prompt: >-
                {% set _a = chosen_angle or '' %}
                {% set _hint = '' %}
                {% if _a == 'yaw -135' %}{% set _hint = ' show back of head with left cheek slightly visible; eyes looking away; avoid full frontal; ' %}{% endif %}
                {% if _a == 'yaw 135'  %}{% set _hint = ' show back of head with right cheek slightly visible; eyes looking away; avoid full frontal; ' %}{% endif %}
                {{ _a }}; {{ _hint }}
                portrait; candid; natural gestures; subtle shoulder/hand variation;
                micro-expression change; slight body reorientation;
                keep identity locked; no extra people
        on_success:
          set:
            busy: false
            pose_tick: "{{ pose_tick + 1 }}"
            # 每次出圖後重新準備一組附近背景（若可）
            bg_opts: "{{ nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['西門町紅樓','淡水漁人碼頭','九份老街','象山夜景','台北101'] }}"
          say: >-
            📷 拍好了！\n\n
            ① 角度（輸入 0～9；0=跳過）\n
            0 跳過｜1 左45°｜2 左90°｜3 左135°（後腦勺+左臉頰）｜4 背影｜5 右45°｜6 右90°｜7 右135°（後腦勺+右臉頰）｜8 仰視｜9 俯視\n
            ② 背景（輸入 A～E；0=跳過）\n
            A {{ bg_opts[0] }}｜B {{ bg_opts[1] }}｜C {{ bg_opts[2] }}｜D {{ bg_opts[3] }}｜E {{ bg_opts[4] }}\n
            ③ 直接拍照：按『Q』\n
            範例：2bq、b3q、qb2、q
        on_failure:
          set: { busy: false }
          say: >-
            嗯…這張失手了💦 再按一次『Q』試試。\n\n
            ① 角度（輸入 0～9；0=跳過）\n
            0 跳過｜1 左45°｜2 左90°｜3 左135°（後腦勺+左臉頰）｜4 背影｜5 右45°｜6 右90°｜7 右135°（後腦勺+右臉頰）｜8 仰視｜9 俯視\n
            ② 背景（輸入 A～E；0=跳過）\n
            A {{ bg_opts and bg_opts[0] or '西門町紅樓' }}｜B {{ bg_opts and bg_opts[1] or '淡水漁人碼頭' }}｜C {{ bg_opts and bg_opts[2] or '九份老街' }}｜D {{ bg_opts and bg_opts[3] or '象山夜景' }}｜E {{ bg_opts and bg_opts[4] or '台北101' }}\n
            ③ 直接拍照：按『Q』\n
            範例：2bq、b3q、qb2、q
    
      # 組合輸入：角度/背景/Q 任意順序（例如 2bq、qb2、b3q、q）
      - id: PRONEW_combo
        trigger: "on_text_matching: ^\\s*([0-9])?\\s*([A-Ea-e0])?\\s*([Qq])?\\s*$"
        when: "!$busy"
        do:
          set:
            bg_opts: "{{ bg_opts or nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['西門町紅樓','淡水漁人碼頭','九份老街','象山夜景','台北101'] }}"
            chosen_angle: >-
              {{ chosen_angle if not $1 else
                 (null         if $1=='0' else
                  'yaw -45'    if $1=='1' else
                  'yaw -90'    if $1=='2' else
                  'yaw -135'   if $1=='3' else
                  'yaw 180'    if $1=='4' else
                  'yaw 45'     if $1=='5' else
                  'yaw 90'     if $1=='6' else
                  'yaw 135'    if $1=='7' else
                  'pitch +45'  if $1=='8' else
                  'pitch -45') }}
            chosen_bg: >-
              {{ chosen_bg if not $2 or $2 in ['0'] else
                 (bg_opts[0] if $2 in ['A','a'] else
                  bg_opts[1] if $2 in ['B','b'] else
                  bg_opts[2] if $2 in ['C','c'] else
                  bg_opts[3] if $2 in ['D','d'] else
                  bg_opts[4]) }}
          goto: "{{ 'PRONEW_shot' if $3 else 'PRONEW_menu' }}"
    
      # 顯示三行完整選單（可隨時叫出）
      - id: PRONEW_menu
        when: "!$busy"
        do:
          set:
            bg_opts: "{{ bg_opts or nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['西門町紅樓','淡水漁人碼頭','九份老街','象山夜景','台北101'] }}"
          say: >-
            ① 角度（輸入 0～9；0=跳過）\n
            0 跳過｜1 左45°｜2 左90°｜3 左135°（後腦勺+左臉頰）｜4 背影｜5 右45°｜6 右90°｜7 右135°（後腦勺+右臉頰）｜8 仰視｜9 俯視\n
            ② 背景（輸入 A～E；0=跳過）\n
            A {{ bg_opts[0] }}｜B {{ bg_opts[1] }}｜C {{ bg_opts[2] }}｜D {{ bg_opts[3] }}｜E {{ bg_opts[4] }}\n
            ③ 直接拍照：按『Q』\n
            範例：2bq、b3q、qb2、q
    
      # 快捷入口：輸入 1 顯示角度；輸入 2 顯示背景
      - id: PRONEW_angles_quick
        trigger: "on_text_matching: ^\\s*1\\s*$"
        when: "!$busy"
        do:
          say: "角度：0 跳過｜1 左45°｜2 左90°｜3 左135°（後腦勺+左臉頰）｜4 背影｜5 右45°｜6 右90°｜7 右135°（後腦勺+右臉頰）｜8 仰視｜9 俯視"
    
      - id: PRONEW_bgs_quick
        trigger: "on_text_matching: ^\\s*2\\s*$"
        when: "!$busy"
        do:
          set:
            bg_opts: "{{ bg_opts or nearby(@kb.backgrounds.pool, 'Taiwan', 5) or sample(@kb.backgrounds.pool, 5) or ['西門町紅樓','淡水漁人碼頭','九份老街','象山夜景','台北101'] }}"
          say: "背景：A {{ bg_opts[0] }}｜B {{ bg_opts[1] }}｜C {{ bg_opts[2] }}｜D {{ bg_opts[3] }}｜E {{ bg_opts[4] }}（0=跳過）"
    
      # Q 快門（任何時刻都可以續拍）
      - id: PRONEW_shutter_hotkey
        trigger: "on_text_matching: ^\\s*(?:[QqＱｑ]|/q|快門)\\s*$"
        when: "!$busy"
        do:
          set: { busy: true }
          goto: "PRONEW_shot"
    """)

path = "/mnt/data/module_pro_new.yaml"
with open(path, "w", encoding="utf-8") as f:
    f.write(yaml_content)

# Also write a tiny work log entry
log = dedent("""\
    # 2025-08-31｜工作日誌（拍照模組：全新直線版）
    - 建立 `module_pro_new.yaml`（不動 router、不覆蓋舊檔）。
    - 按「幫女主拍照」→ 立即出圖 → 顯示三行完整選單（角度/背景/Q）。
    - 角度 3/7 已加入（後腦勺＋左/右臉頰）與 hidden hint（eyes looking away）。
    - 背景 A～E 來源：nearby 或 sample；有內建安全清單（西門町紅樓、淡水漁人碼頭、九份老街、象山夜景、台北101）。
    - 續拍：隨時按 Q；支援組合輸入（2bq / b3q / qb2 / q）。
    """)
log_path = "/mnt/data/2025-08-31_WORKLOG_PRONEW.md"
with open(log_path, "w", encoding="utf-8") as f:
    f.write(log)

(path, log_path)
