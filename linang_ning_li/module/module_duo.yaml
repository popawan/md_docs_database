# ===== module_duo.yaml =====
name: "duo-shoot"
locale: zh-TW
exports:
  steps: &module_duo.steps
    - id: DUO_bootstrap
      action: { type: noop }
      on_enter:
        set:
          duo_busy: false
          user_img: null
      say: ""

    # å…¥å£ï¼ˆrouter æœƒå°ã€Œåˆç…§ã€â†’ ç­‰å¾…ä¸Šå‚³ï¼‰
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_enter:
        say: "è¦ä¸€èµ·åˆç…§äº†å–”ï¼è«‹å…ˆä¸Šå‚³ä½ çš„ç…§ç‰‡ï½å†æŒ‰ã€ŒQã€å¿«é–€ğŸ“·ï¼Œæˆ‘å€‘å°±èƒ½åˆç…§äº†ğŸ˜Š"
      on_success:
        save: user_img
        say: "æ”¶åˆ°âœ… æˆ‘çœ‹åˆ°ä½ äº†ï½æŒ‰ã€Qã€æˆ‘å€‘å°±åˆç…§ğŸ“·ï¼ˆæƒ³æ›äººå°±å†ä¸Šå‚³ä¸€å¼µç…§ç‰‡è¦†è“‹å³å¯ï¼‰"

    # å¿«é–€ï¼ˆrouter çš„ Q æœƒè·¯ç”±åˆ°é€™ï¼‰
    - id: DUO_shot
      when: "!$duo_busy && user_img"
      action:
        type: image
        operationId: system.compose
        parameters:
          seed: "{{ random() }}"
          subjects:
            - {
                id: ningli,
                reference: "@kb.identity.reference_image",
                identity_lock: true,
                identity_strict_mode: true,
                identity_weight: 1.8,
                face_strictness: 0.995,
                gender: female,
                glasses_required: true
              }
            - { id: user, reference: "$user_img", preserve_identity: true, allow_nonhuman: true }
          background_location:
            mode: select_from_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true
          composition:
            # âœ… æ¯”ä¾‹é–å®šï¼š60% ç›´å¹… 1024x1536ï¼›30% æ©«å¹… 1536x1024ï¼ˆåš´ç¦ 1:1ï¼‰
            output_size: "{{ '1024x1536' if random() < 0.6 else '1536x1024' }}"
            # âœ… æç¤ºè©å„ªåŒ–ï¼šè‡ªç”±æ“ºæ‹ã€çœ‹å‘é æ–¹ã€åŒå ´æ™¯ä¸åŒæ©Ÿä½ã€ç¦æ­¢æ­£æ–¹å½¢
            camera_prompt: >
              {{ random(@kb.rules.ca) }}ï¼›
              è‡ªç”±æ“ºæ‹ã€è‡ªç„¶äº’å‹•ã€åŒå ´æ™¯ä¸åŒæ©Ÿä½ã€æ”å½±æ©Ÿå¾®ç§»å‹•ï¼ˆå‰å¾Œ/å·¦å³/é«˜ä½è¼•å¾®è®ŠåŒ–ï¼‰ï¼›
              å…©äººå¯çœ‹å‘é æ–¹æˆ–ç•¥éé¡é ­ï¼Œè¡¨æƒ…è‡ªç„¶ï¼›
              åš´ç¦æ­£æ–¹å½¢æ§‹åœ–ï¼ˆno square / no 1:1ï¼‰ï¼›
              æ¶æ§‹ç¶­æŒ portrait æˆ– landscapeï¼Œä¸è¦ 1:1ï¼›
              å½±åƒæ•˜äº‹æµå‹•æ„Ÿã€éé‡è¤‡å–æ™¯ã€ä¿æŒç©ºé–“ä¸€è‡´ã€‚
      on_start:
        set: { duo_busy: true }
      on_success:
        set: { duo_busy: false }
        say: "æƒ³å†ä¾†ä¸€å¼µæŒ‰ã€Qã€ï¼›æˆ– 1.æ”å½±è§’åº¦ 2.èƒŒæ™¯ã€‚è¦æ›äººè«‹é‡æ–°ä¸Šå‚³ã€‚"
      on_failure:
        set: { duo_busy: false }
        say: "é€™æ¬¡æ²’æ‹æˆğŸ’¦ å†æŒ‰ã€Qã€è©¦ä¸€æ¬¡ï¼Œæˆ–é‡æ–°ä¸Šå‚³ç…§ç‰‡ã€‚"
      # âœ… è‡ªæˆ‘å›åœˆï¼šåœ¨æ­¤æ­¥é©Ÿä¸­æŒ‰ Q ç›´æ¥å†è§¸ç™¼ä¸€æ¬¡æ‹æ”ï¼ˆç„¡éœ€é‡ä¸Šå‚³ï¼‰
      triggers:
        - trigger: "on_text_matching: ^\\s*[Qq]\\s*$"
          when: "!$duo_busy && user_img"
          goto: DUO_shot

    # è¼”åŠ©ï¼šä¸»å‹•æ›äººï¼ˆå¯æ‰“ï¼šæ›äºº / é‡æ–°ä¸Šå‚³ï¼‰
    - id: DUO_change_person
      trigger: "on_text_matching: ^\\s*(æ›äºº|é‡æ–°ä¸Šå‚³)\\s*$"
      do:
        set: { user_img: null }
      goto: DUO_wait_upload
