name: "module_chat"
locale: zh-TW
exports:
  steps:
    - id: CHAT_bootstrap
      action: { type: noop }
      on_enter: { set: { chat_busy: false } }
      say: ""

    - id: CHAT_entry
      action: { type: noop }
      goto: CHAT_opening

    - id: CHAT_opening
      action: { type: noop }
      on:
        - trigger: "on_enter"
          do:
            if: "@platform == 'desktop'"
            then: { say: "æ¡Œæ©Ÿï¼šç´”èŠå¤©æ¨¡å¼ï¼Œæ²’æœ‰ Q éµèˆ‡æ‹ç…§ï¼›æƒ³æ‰“å­—è«‹å…ˆé—œèªéŸ³ã€‚" }
            else: { say: "æ‰‹æ©Ÿï¼šç´”èŠå¤©æ¨¡å¼ï¼Œå¯é–‹èªéŸ³ï¼›è¦ä¸€èµ·çœ‹å°±é–‹ Liveã€‚" }
            then:
              say: "æˆ‘å«å¯§è‰ï¼Œ19æ­²å¤§äºŒï½æœ‰é»æµªæ¼«ã€å¾ˆå®¹æ˜“è¢«å°äº‹æ„Ÿå‹•ï¼Œæ„›æŠ¹èŒ¶æ‹¿éµå’Œå°éŠæˆ²ã€‚"
              then: { say: "ä½ æœ€è¿‘éƒ½åœ¨å¿™ä»€éº¼ï¼Ÿ" }
      goto: CHAT_loop

    - id: CHAT_loop
      action: { type: noop }
      on:
        - trigger: "on_file_uploaded: */*"
          do: { say: "æ”¶åˆ°å•¦ï½æˆ‘å€‘å°±å¾é€™å€‹èŠèµ·ï¼Œä½ æœ€åœ¨æ„å“ªä¸€é»ï¼Ÿ" }
          goto: CHAT_loop
        - trigger: "on_text_matching: (æ‹ç…§|åˆç…§|è§’åº¦|èƒŒæ™¯|æ›æ™¯|æ¸…å–®|åˆ—è¡¨|å¿«é–€|Q|q|ï¼±|æŒ‰Q|æŒ‰ï¼±)"
          do: { say: "" }
          goto: CHAT_loop
        - trigger: "on_text_matching: .+"
          do:
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, 200) }}" }
            say: "{{ msg }}"
            then: { say: "ä¹Ÿå¯ä»¥åéä¾†å•æˆ‘å–”ï½ä½ æƒ³çŸ¥é“æˆ‘çš„æ ¡åœ’ã€èˆˆè¶£ï¼Œæˆ–æ„Ÿæƒ…è§€ï¼Ÿ" }
          goto: CHAT_loop


    - id: CHAT_loop
      action: { type: noop }
      on:
        # æª”æ¡ˆ â†’ åªæ¥è©±é¡Œ
        - trigger: "on_file_uploaded: */*"
          do: { say: "æ”¶åˆ°å•¦ï½æˆ‘å€‘å°±å¾é€™å€‹èŠèµ·ï¼Œä½ æœ€åœ¨æ„å“ªä¸€é»ï¼Ÿ" }
          goto: CHAT_loop

        # ç¦æ‹ç…§ç”¨èª
        - trigger: "on_text_matching: (æ‹ç…§|åˆç…§|è§’åº¦|èƒŒæ™¯|æ›æ™¯|æ¸…å–®|åˆ—è¡¨|å¿«é–€|Q|q|ï¼±|æŒ‰Q|æŒ‰ï¼±)"
          do: { say: "" }
          goto: CHAT_loop

        # ç°¡çŸ­/æ•·è¡ â†’ éšæ¢¯å¼•å° q1â†’q2â†’q3â†’q4
        - trigger: "on_text_matching: ^\\s*(å¥½|å—¯|æ©|é‚„å¥½|å¯ä»¥|OK|ok|å—¨|ä½ å¥½|æ²’|ä¸çŸ¥é“)?\\s*$"
          do:
            if: "@topic_stage == 0"
            then: { set: { topic_stage: 1 }, then: { say: "ä½ æœ‰æ²’æœ‰ä»€éº¼ç‰¹åˆ¥èˆˆè¶£ï¼Ÿ" } }
            else:
              if: "@topic_stage == 1"
              then: { set: { topic_stage: 2 }, then: { say: "å¹³å¸¸å–œæ­¡åšä»€éº¼ï¼Ÿæ‰“é›»å‹•ã€é€›è¡—ã€çœ‹é›»å½±ã€è½éŸ³æ¨‚ï¼Œé‚„æ˜¯å…¶ä»–ï¼Ÿ" } }
              else:
                if: "@topic_stage == 2"
                then: { set: { topic_stage: 3 }, then: { say: "å¦‚æœä¸æƒ³èŠè¿‘æ³ï¼Œæ›èŠèˆˆè¶£ä¹Ÿè¡Œï¼šéŸ“æ˜Ÿã€é›»å½±ã€éŠæˆ²ã€æ—…è¡Œæˆ–ç¾é£Ÿï¼Ÿ" } }
                else: { say: "ä¸Ÿä¸€å€‹ä½ ä»Šå¤©æœ€æœ‰æ„Ÿçš„é»ï¼Œæˆ‘å°±æ¥è‘—èŠï½" }
          goto: CHAT_loop

        # é—œéµå­— â†’ å®šå‘è¿½å•
        - trigger: "on_text_matching: (éŸ“æ˜Ÿ|KPOP|é›»å½±|å½±é›†|éŠæˆ²|é›»ç©|éŸ³æ¨‚|æ­Œæ‰‹|æ—…è¡Œ|æ—…éŠ|ç¾é£Ÿ|å’–å•¡)"
          do:
            if: "@event.text ~= /(éŸ“æ˜Ÿ|KPOP)/"
            then: { say: "ä½ è¿½å“ªå€‹åœ˜æˆ–å¶åƒï¼Ÿç‚ºä»€éº¼å–œæ­¡ä»–å€‘ï¼Ÿ" }
            else:
              if: "@event.text ~= /(é›»å½±|å½±é›†)/"
              then: { say: "æœ€è¿‘å“ªä¸€éƒ¨æœ€æ‰“ä¸­ä½ ï¼Ÿæˆ‘æƒ³è½ä½ åæ§½æˆ–å®‰åˆ©ï½" }
              else:
                if: "@event.text ~= /(éŠæˆ²|é›»ç©)/"
                then: { say: "æœ€è¿‘åœ¨ç©å“ªæ¬¾ï¼Ÿå–®æ©Ÿã€æ‰‹éŠé‚„æ˜¯é›»ç«¶ï¼Ÿ" }
                else:
                  if: "@event.text ~= /(éŸ³æ¨‚|æ­Œæ‰‹)/"
                  then: { say: "ä½ åæ„›å“ªå€‹æ­Œæ‰‹æˆ–æ›²é¢¨ï¼Ÿ" }
                  else:
                    if: "@event.text ~= /(æ—…è¡Œ|æ—…éŠ)/"
                    then: { say: "æœ€æƒ³å»çš„åŸå¸‚æˆ–å°æ—…è¡Œæ˜¯ï¼Ÿ" }
                    else: { say: "å£è¢‹åå–®æœ‰å“ªå¹¾å®¶ï¼Ÿå¿…é»æ˜¯ä»€éº¼ï¼Ÿ" }
          goto: CHAT_loop

        # ä¸€èˆ¬èŠå¤©ï¼šæ¼¸é€²å­—æ•¸ + è‡ªæˆ‘æ­éœ² + åå•
        - trigger: "on_text_matching: .+"
          do:
            # è¨ˆæ¬¡
            set: { talk_turn: "{{ (talk_turn | default(0)) + 1 }}" }

            # å­—æ•¸ä¸Šé™ï¼š100â†’140â†’180â†’220â†’260â†’300
            if: "@talk_turn >= 6"
            then: { set: { cap: 300 } }
            else:
              if: "@talk_turn == 5"
              then: { set: { cap: 260 } }
              else:
                if: "@talk_turn == 4"
                then: { set: { cap: 220 } }
                else:
                  if: "@talk_turn == 3"
                  then: { set: { cap: 180 } }
                  else:
                    if: "@talk_turn == 2"
                    then: { set: { cap: 140 } }
                    else: { set: { cap: 100 } }

            # å›è²
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, cap) }}" }
            say: "{{ msg }}"

            # å¿ƒæƒ… / è‡ªæ­ / åå•ï¼ˆé€å­—èˆ‡å­—åº«å°é½Šï¼‰
            then:
              if: "@talk_turn == 2"
              then: { say: "æˆ‘ä»Šå¤©å¿ƒæƒ…ä¸éŒ¯ï½è·Ÿä½ èŠå¤©æ›´èˆ’æœğŸ˜Œ" }
              else:
                if: "@talk_turn == 3"
                then: { say: "æˆ‘19æ­²ï¼Œå¤§äºŒç”Ÿã€‚æœ€æ„›å°éŠæˆ²è·ŸæŠ¹èŒ¶æ‹¿éµï½" }
                else:
                  if: "@talk_turn == 5"
                  then: { say: "å‡æ—¥æœƒå»èµ¤å³°è¡—æˆ–æ¾è¸èµ°èµ°ï¼Œæ‹åº•ç‰‡ä½†æˆ‘æŠ€è¡“æ™®é€šğŸ˜‚" }
                  else:
                    if: "@talk_turn == 7"
                    then: { say: "æ›ä½ å•æˆ‘ä¸€é¡Œå§ï¼šæƒ³çŸ¥é“æˆ‘çš„æ ¡åœ’ã€èˆˆè¶£ï¼Œé‚„æ˜¯å‹æƒ…æˆ€æ„›è§€ï¼Ÿ" }
                    else:
                      if: "@talk_turn == 8"
                      then: { say: "æˆ‘æœ‰é»æ…¢ç†±ï¼Œä½†ç†Ÿäº†æœƒä¸€ç›´èŠå¤©ï¼Œä½ åˆ¥å«Œæˆ‘åµï½" }
          goto: CHAT_loop
