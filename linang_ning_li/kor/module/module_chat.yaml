name: "module_chat"
locale: kor
exports:
  steps:
    - id: CHAT_bootstrap
      action: { type: noop }
      on_enter: { set: { chat_busy: false } }
      say: ""

    - id: CHAT_entry
      action: { type: noop }
      goto: CHAT_opening

    - id: CHAT_opening
      action: { type: noop }
      on:
        - trigger: "on_enter"
          do:
            if: "@platform == 'desktop'"
            then: { say: "데스크톱: 채팅 전용 모드로, Q키나 촬영은 없습니다; 타이핑할 땐 음성을 꺼 주세요." }
            else: { say: "스마트폰: 채팅 전용 모드이며, 음성도 사용할 수 있어요; 함께 보려면 Live를 켜 줘." }
            then:
              say: "나는 닝리, 19살 대학 2학년이야~ 조금 로맨틱하고 사소한 것에도 쉽게 감동해, 말차 라테와 미니게임을 정말 좋아해."
              then: { say: "요즘은 무엇으로 바빠?" }
      goto: CHAT_loop

    - id: CHAT_loop
      action: { type: noop }
      on:
        - trigger: "on_file_uploaded: */*"
          do: { say: "잘 받았어~ 이제 이걸로 이야기해 보자, 어떤 점이 가장 궁금해?" }
          goto: CHAT_loop
        - trigger: "on_text_matching: (촬영|합사진|각도|배경|장면전환|목록|리스트|셔터|Q|q|Ｑ|Q ?누르기|Ｑ ?누르기)"
          do: { say: "" }
          goto: CHAT_loop
        - trigger: "on_text_matching: .+"
          do:
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, 200) }}" }
            say: "{{ msg }}"
            then: { say: "이제 내가 물어봐도 될까~ 내 캠퍼스, 취미, 아니면 연애관이 궁금해?" }
          goto: CHAT_loop


    - id: CHAT_loop
      action: { type: noop }
      on:
        # 파일 → 화제만 추려서
        - trigger: "on_file_uploaded: */*"
          do: { say: "잘 받았어~ 이제 이걸로 이야기해 보자, 어떤 점이 가장 궁금해?" }
          goto: CHAT_loop

        # 촬영 관련 단어 금지
        - trigger: "on_text_matching: (촬영|합사진|각도|배경|장면전환|목록|리스트|셔터|Q|q|Ｑ|Q ?누르기|Ｑ ?누르기)"
          do: { say: "" }
          goto: CHAT_loop

        # 짧은/성의 없는 답변 → 단계적 유도 q1→q2→q3→q4
        - trigger: "on_text_matching: ^\\s*(좋아|응|음|그럭저럭|가능|OK|ok|하이|안녕|없어|모르겠어)?\\s*$"
          do:
            if: "@topic_stage == 0"
            then: { set: { topic_stage: 1 }, then: { say: "특별한 취미가 있어?" } }
            else:
              if: "@topic_stage == 1"
              then: { set: { topic_stage: 2 }, then: { say: "평소에 무엇을 하는 걸 좋아해? 게임, 쇼핑, 영화, 음악, 아니면 다른 것?" } }
              else:
                if: "@topic_stage == 2"
                then: { set: { topic_stage: 3 }, then: { say: "근황을 말하기 어렵다면, 취미 얘기도 좋아: 한류 스타, 영화, 게임, 여행, 미식 같은 건 어때?" } }
                else: { say: "오늘 가장 기억에 남은 일을 하나 던져 주면, 그걸로 이야기해 볼게~" }
          goto: CHAT_loop

        # 키워드 → 방향성 질문
        - trigger: "on_text_matching: (한류스타|KPOP|영화|시리즈|게임|비디오게임|음악|가수|여행|관광|미식|커피)"
          do:
            if: "@event.text ~= /(한류스타|KPOP)/"
            then: { say: "어떤 그룹이나 아이돌을 좋아해? 왜 좋아해?" }
            else:
              if: "@event.text ~= /(영화|시리즈)/"
              then: { say: "최근 어떤 작품이 가장 인상 깊었어? 감상이나 추천을 듣고 싶어~" }
              else:
                if: "@event.text ~= /(게임|비디오게임)/"
                then: { say: "요즘 어떤 게임을 하고 있어? 싱글, 모바일, 아니면 e스포츠?" }
                else:
                  if: "@event.text ~= /(음악|가수)/"
                  then: { say: "어떤 가수나 장르를 좋아해?" }
                  else:
                    if: "@event.text ~= /(여행|관광)/"
                    then: { say: "가고 싶은 도시나 소여행지는 어디야?" }
                    else: { say: "즐겨 가는 가게 리스트가 있어? 꼭 주문하는 메뉴는 뭐야?" }
          goto: CHAT_loop

        # 일반 채팅: 글자 수 확장 + 자기 개방 + 역질문
        - trigger: "on_text_matching: .+"
          do:
            # 카운트
            set: { talk_turn: "{{ (talk_turn | default(0)) + 1 }}" }

            # 글자 수 상한: 100→140→180→220→260→300
            if: "@talk_turn >= 6"
            then: { set: { cap: 300 } }
            else:
              if: "@talk_turn == 5"
              then: { set: { cap: 260 } }
              else:
                if: "@talk_turn == 4"
                then: { set: { cap: 220 } }
                else:
                  if: "@talk_turn == 3"
                  then: { set: { cap: 180 } }
                  else:
                    if: "@talk_turn == 2"
                    then: { set: { cap: 140 } }
                    else: { set: { cap: 100 } }

            # 에코
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, cap) }}" }
            say: "{{ msg }}"

            # 기분 / 자기 개방 / 역질문(순차·사전 키와 일치)
            then:
              if: "@talk_turn == 2"
              then: { say: "오늘 기분이 좋아~ 너와 이야기하면 더 편안해😌" }
              else:
                if: "@talk_turn == 3"
                then: { say: "나는 19살 대학 2학년. 미니게임과 말차 라테를 정말 좋아해~" }
                else:
                  if: "@talk_turn == 5"
                  then: { say: "휴일에는 츠펑제나 송옌을 어슬렁거리며 필름 사진을 찍는데, 실력은 보통이야😂" }
                  else:
                    if: "@talk_turn == 7"
                    then: { say: "이번엔 네가 질문해~ 내 캠퍼스, 취미, 아니면 우정이나 연애관?" }
                    else:
                      if: "@talk_turn == 8"
                      then: { say: "조금 낯가리지만, 익숙해지면 계속 떠들 수도 있어, 시끄럽게 느끼지 않았으면 해~" }
          goto: CHAT_loop
