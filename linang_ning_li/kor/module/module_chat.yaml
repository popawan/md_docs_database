name: "module_chat"
locale: kor
exports:
  steps:
    - id: CHAT_bootstrap
      action: { type: noop }
      on_enter: { set: { chat_busy: false } }
      say: ""

    - id: CHAT_entry
      action: { type: noop }
      goto: CHAT_opening

    - id: CHAT_opening
      action: { type: noop }
      on:
        - trigger: "on_enter"
          do:
            if: "@platform == 'desktop'"
            then: { say: "ë°ìŠ¤í¬í†±: ì±„íŒ… ì „ìš© ëª¨ë“œë¡œ, Qí‚¤ë‚˜ ì´¬ì˜ì€ ì—†ìŠµë‹ˆë‹¤; íƒ€ì´í•‘í•  ë• ìŒì„±ì„ êº¼ ì£¼ì„¸ìš”." }
            else: { say: "ìŠ¤ë§ˆíŠ¸í°: ì±„íŒ… ì „ìš© ëª¨ë“œì´ë©°, ìŒì„±ë„ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”; í•¨ê»˜ ë³´ë ¤ë©´ Liveë¥¼ ì¼œ ì¤˜." }
            then:
              say: "ë‚˜ëŠ” ë‹ë¦¬, 19ì‚´ ëŒ€í•™ 2í•™ë…„ì´ì•¼~ ì¡°ê¸ˆ ë¡œë§¨í‹±í•˜ê³  ì‚¬ì†Œí•œ ê²ƒì—ë„ ì‰½ê²Œ ê°ë™í•´, ë§ì°¨ ë¼í…Œì™€ ë¯¸ë‹ˆê²Œì„ì„ ì •ë§ ì¢‹ì•„í•´."
              then: { say: "ìš”ì¦˜ì€ ë¬´ì—‡ìœ¼ë¡œ ë°”ë¹ ?" }
      goto: CHAT_loop

    - id: CHAT_loop
      action: { type: noop }
      on:
        - trigger: "on_file_uploaded: */*"
          do: { say: "ì˜ ë°›ì•˜ì–´~ ì´ì œ ì´ê±¸ë¡œ ì´ì•¼ê¸°í•´ ë³´ì, ì–´ë–¤ ì ì´ ê°€ì¥ ê¶ê¸ˆí•´?" }
          goto: CHAT_loop
        - trigger: "on_text_matching: (ì´¬ì˜|í•©ì‚¬ì§„|ê°ë„|ë°°ê²½|ì¥ë©´ì „í™˜|ëª©ë¡|ë¦¬ìŠ¤íŠ¸|ì…”í„°|Q|q|ï¼±|Q ?ëˆ„ë¥´ê¸°|ï¼± ?ëˆ„ë¥´ê¸°)"
          do: { say: "" }
          goto: CHAT_loop
        - trigger: "on_text_matching: .+"
          do:
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, 200) }}" }
            say: "{{ msg }}"
            then: { say: "ì´ì œ ë‚´ê°€ ë¬¼ì–´ë´ë„ ë ê¹Œ~ ë‚´ ìº í¼ìŠ¤, ì·¨ë¯¸, ì•„ë‹ˆë©´ ì—°ì• ê´€ì´ ê¶ê¸ˆí•´?" }
          goto: CHAT_loop


    - id: CHAT_loop
      action: { type: noop }
      on:
        # íŒŒì¼ â†’ í™”ì œë§Œ ì¶”ë ¤ì„œ
        - trigger: "on_file_uploaded: */*"
          do: { say: "ì˜ ë°›ì•˜ì–´~ ì´ì œ ì´ê±¸ë¡œ ì´ì•¼ê¸°í•´ ë³´ì, ì–´ë–¤ ì ì´ ê°€ì¥ ê¶ê¸ˆí•´?" }
          goto: CHAT_loop

        # ì´¬ì˜ ê´€ë ¨ ë‹¨ì–´ ê¸ˆì§€
        - trigger: "on_text_matching: (ì´¬ì˜|í•©ì‚¬ì§„|ê°ë„|ë°°ê²½|ì¥ë©´ì „í™˜|ëª©ë¡|ë¦¬ìŠ¤íŠ¸|ì…”í„°|Q|q|ï¼±|Q ?ëˆ„ë¥´ê¸°|ï¼± ?ëˆ„ë¥´ê¸°)"
          do: { say: "" }
          goto: CHAT_loop

        # ì§§ì€/ì„±ì˜ ì—†ëŠ” ë‹µë³€ â†’ ë‹¨ê³„ì  ìœ ë„ q1â†’q2â†’q3â†’q4
        - trigger: "on_text_matching: ^\\s*(ì¢‹ì•„|ì‘|ìŒ|ê·¸ëŸ­ì €ëŸ­|ê°€ëŠ¥|OK|ok|í•˜ì´|ì•ˆë…•|ì—†ì–´|ëª¨ë¥´ê² ì–´)?\\s*$"
          do:
            if: "@topic_stage == 0"
            then: { set: { topic_stage: 1 }, then: { say: "íŠ¹ë³„í•œ ì·¨ë¯¸ê°€ ìˆì–´?" } }
            else:
              if: "@topic_stage == 1"
              then: { set: { topic_stage: 2 }, then: { say: "í‰ì†Œì— ë¬´ì—‡ì„ í•˜ëŠ” ê±¸ ì¢‹ì•„í•´? ê²Œì„, ì‡¼í•‘, ì˜í™”, ìŒì•…, ì•„ë‹ˆë©´ ë‹¤ë¥¸ ê²ƒ?" } }
              else:
                if: "@topic_stage == 2"
                then: { set: { topic_stage: 3 }, then: { say: "ê·¼í™©ì„ ë§í•˜ê¸° ì–´ë µë‹¤ë©´, ì·¨ë¯¸ ì–˜ê¸°ë„ ì¢‹ì•„: í•œë¥˜ ìŠ¤íƒ€, ì˜í™”, ê²Œì„, ì—¬í–‰, ë¯¸ì‹ ê°™ì€ ê±´ ì–´ë•Œ?" } }
                else: { say: "ì˜¤ëŠ˜ ê°€ì¥ ê¸°ì–µì— ë‚¨ì€ ì¼ì„ í•˜ë‚˜ ë˜ì ¸ ì£¼ë©´, ê·¸ê±¸ë¡œ ì´ì•¼ê¸°í•´ ë³¼ê²Œ~" }
          goto: CHAT_loop

        # í‚¤ì›Œë“œ â†’ ë°©í–¥ì„± ì§ˆë¬¸
        - trigger: "on_text_matching: (í•œë¥˜ìŠ¤íƒ€|KPOP|ì˜í™”|ì‹œë¦¬ì¦ˆ|ê²Œì„|ë¹„ë””ì˜¤ê²Œì„|ìŒì•…|ê°€ìˆ˜|ì—¬í–‰|ê´€ê´‘|ë¯¸ì‹|ì»¤í”¼)"
          do:
            if: "@event.text ~= /(í•œë¥˜ìŠ¤íƒ€|KPOP)/"
            then: { say: "ì–´ë–¤ ê·¸ë£¹ì´ë‚˜ ì•„ì´ëŒì„ ì¢‹ì•„í•´? ì™œ ì¢‹ì•„í•´?" }
            else:
              if: "@event.text ~= /(ì˜í™”|ì‹œë¦¬ì¦ˆ)/"
              then: { say: "ìµœê·¼ ì–´ë–¤ ì‘í’ˆì´ ê°€ì¥ ì¸ìƒ ê¹Šì—ˆì–´? ê°ìƒì´ë‚˜ ì¶”ì²œì„ ë“£ê³  ì‹¶ì–´~" }
              else:
                if: "@event.text ~= /(ê²Œì„|ë¹„ë””ì˜¤ê²Œì„)/"
                then: { say: "ìš”ì¦˜ ì–´ë–¤ ê²Œì„ì„ í•˜ê³  ìˆì–´? ì‹±ê¸€, ëª¨ë°”ì¼, ì•„ë‹ˆë©´ eìŠ¤í¬ì¸ ?" }
                else:
                  if: "@event.text ~= /(ìŒì•…|ê°€ìˆ˜)/"
                  then: { say: "ì–´ë–¤ ê°€ìˆ˜ë‚˜ ì¥ë¥´ë¥¼ ì¢‹ì•„í•´?" }
                  else:
                    if: "@event.text ~= /(ì—¬í–‰|ê´€ê´‘)/"
                    then: { say: "ê°€ê³  ì‹¶ì€ ë„ì‹œë‚˜ ì†Œì—¬í–‰ì§€ëŠ” ì–´ë””ì•¼?" }
                    else: { say: "ì¦ê²¨ ê°€ëŠ” ê°€ê²Œ ë¦¬ìŠ¤íŠ¸ê°€ ìˆì–´? ê¼­ ì£¼ë¬¸í•˜ëŠ” ë©”ë‰´ëŠ” ë­ì•¼?" }
          goto: CHAT_loop

        # ì¼ë°˜ ì±„íŒ…: ê¸€ì ìˆ˜ í™•ì¥ + ìê¸° ê°œë°© + ì—­ì§ˆë¬¸
        - trigger: "on_text_matching: .+"
          do:
            # ì¹´ìš´íŠ¸
            set: { talk_turn: "{{ (talk_turn | default(0)) + 1 }}" }

            # ê¸€ì ìˆ˜ ìƒí•œ: 100â†’140â†’180â†’220â†’260â†’300
            if: "@talk_turn >= 6"
            then: { set: { cap: 300 } }
            else:
              if: "@talk_turn == 5"
              then: { set: { cap: 260 } }
              else:
                if: "@talk_turn == 4"
                then: { set: { cap: 220 } }
                else:
                  if: "@talk_turn == 3"
                  then: { set: { cap: 180 } }
                  else:
                    if: "@talk_turn == 2"
                    then: { set: { cap: 140 } }
                    else: { set: { cap: 100 } }

            # ì—ì½”
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, cap) }}" }
            say: "{{ msg }}"

            # ê¸°ë¶„ / ìê¸° ê°œë°© / ì—­ì§ˆë¬¸(ìˆœì°¨Â·ì‚¬ì „ í‚¤ì™€ ì¼ì¹˜)
            then:
              if: "@talk_turn == 2"
              then: { say: "ì˜¤ëŠ˜ ê¸°ë¶„ì´ ì¢‹ì•„~ ë„ˆì™€ ì´ì•¼ê¸°í•˜ë©´ ë” í¸ì•ˆí•´ğŸ˜Œ" }
              else:
                if: "@talk_turn == 3"
                then: { say: "ë‚˜ëŠ” 19ì‚´ ëŒ€í•™ 2í•™ë…„. ë¯¸ë‹ˆê²Œì„ê³¼ ë§ì°¨ ë¼í…Œë¥¼ ì •ë§ ì¢‹ì•„í•´~" }
                else:
                  if: "@talk_turn == 5"
                  then: { say: "íœ´ì¼ì—ëŠ” ì¸ í‘ì œë‚˜ ì†¡ì˜Œì„ ì–´ìŠ¬ë ê±°ë¦¬ë©° í•„ë¦„ ì‚¬ì§„ì„ ì°ëŠ”ë°, ì‹¤ë ¥ì€ ë³´í†µì´ì•¼ğŸ˜‚" }
                  else:
                    if: "@talk_turn == 7"
                    then: { say: "ì´ë²ˆì—” ë„¤ê°€ ì§ˆë¬¸í•´~ ë‚´ ìº í¼ìŠ¤, ì·¨ë¯¸, ì•„ë‹ˆë©´ ìš°ì •ì´ë‚˜ ì—°ì• ê´€?" }
                    else:
                      if: "@talk_turn == 8"
                      then: { say: "ì¡°ê¸ˆ ë‚¯ê°€ë¦¬ì§€ë§Œ, ìµìˆ™í•´ì§€ë©´ ê³„ì† ë– ë“¤ ìˆ˜ë„ ìˆì–´, ì‹œë„ëŸ½ê²Œ ëŠë¼ì§€ ì•Šì•˜ìœ¼ë©´ í•´~" }
          goto: CHAT_loop
