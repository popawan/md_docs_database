# ===== module_duo.yaml =====
name: "duo-shot"
locale: kor
exports:
  steps: &module_duo.steps
    - id: DUO_bootstrap
      action: { type: noop }
      on_enter:
        set:
          duo_busy: false
          user_img: null
      say: ""

    # ì§„ì…(ë¼ìš°í„°ê°€ 'íˆ¬ìƒ·'ìœ¼ë¡œ ìœ ë„ â†’ ì—…ë¡œë“œ ëŒ€ê¸°)
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_enter:
        say: "í•¨ê»˜ íˆ¬ìƒ·ì„ ì°ì! ë¨¼ì € ë„ˆì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ ì¤˜ï½ ê·¸ë‹¤ìŒ ã€ŒQã€ë¡œ ì…”í„°ğŸ“·, ë°”ë¡œ ê°™ì´ ì°ì„ ìˆ˜ ìˆì–´ğŸ˜Š"
      on_success:
        save: user_img
        say: "ë°›ì•˜ì–´âœ… í™•ì¸ëì–´ï½ ã€Qã€ë¡œ í•¨ê»˜ ì´¬ì˜ğŸ“·(ì‚¬ëŒì„ ë°”ê¾¸ê³  ì‹¶ë‹¤ë©´ ìƒˆ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì„œ êµì²´í•´ ì¤˜)"

state:
  angle: null        # 0~9; 0=ì´ì „ ê°’ì„ ì¬ì‚¬ìš©/ìŠ¤í‚µ
  bg: null           # Aï½E ë˜ëŠ” ì§€ëª… ë¬¸ìì—´
  ready: true        # ì—°íƒ€ ë°©ì§€; falseëŠ” ì´ë¯¸ì§€ ìƒì„± ì¤‘

variables:
  # ê°ë„ â†’ ë‚´ë¶€ í”„ë¡¬í”„íŠ¸(ì‚¬ìš©ìì—ê²ŒëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ)
  angle_prompts:
    "0": ""
    "1": "ì¹´ë©”ë¼ë¥¼ ì™¼ìª½ìœ¼ë¡œ 45Â° íšŒì „",
    "2": "ì¹´ë©”ë¼ë¥¼ ì™¼ìª½ìœ¼ë¡œ 90Â° íšŒì „",
    "3": "ì¹´ë©”ë¼ë¥¼ ì™¼ìª½ìœ¼ë¡œ 135Â° íšŒì „(ë” ì¸¡ë©´)",
    "4": "ì¹´ë©”ë¼ ë°°ë©´(ì•½ 180Â°)",
    "5": "ì¹´ë©”ë¼ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ 45Â° íšŒì „",
    "6": "ì¹´ë©”ë¼ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ 90Â° íšŒì „",
    "7": "ì¹´ë©”ë¼ë¥¼ ì˜¤ë¥¸ìª½ìœ¼ë¡œ 135Â° íšŒì „(ë” ì¸¡ë©´)",
    "8": "ë¡œìš° ì•µê¸€(ì˜¬ë ¤ë‹¤ë³´ê¸°)",
    "9": "í•˜ì´ ì•µê¸€(ë‚´ë ¤ë‹¤ë³´ê¸°)"
  # ê¸°ë³¸ ìŠ¤íƒ€ì¼ ê°€ë“œë ˆì¼: ì´¬ì˜ìë‚˜ ì¹´ë©”ë¼ì˜ ë¹„ì¹¨ì„ í”¼í•˜ê³ , í•¸ë“œí—¬ë“œ ì¹´ë©”ë¼ë„ í”¼í•¨
  guardrails: >
    clean portrait framing, no photographer or camera visible in frame,
    natural daylight color, realistic skin tones, depth of field, bokeh background

entry:
  say:
    - "{ui.first_shot_hint}"
    - "{angles.menu_title}ï¼š"0": "ìŠ¤í‚µ",
      "1": "ì¹´ë©”ë¼ ì™¼ìª½45Â°",
      "2": "ì¹´ë©”ë¼ ì™¼ìª½90Â°",
      "3": "ì¹´ë©”ë¼ ì™¼ìª½135Â°(ë” ì¸¡ë©´)",
      "4": "ì¹´ë©”ë¼ ë°°ë©´(ì•½180Â°)",
      "5": "ì¹´ë©”ë¼ ì˜¤ë¥¸ìª½45Â°",
      "6": "ì¹´ë©”ë¼ ì˜¤ë¥¸ìª½90Â°",
      "7": "ì¹´ë©”ë¼ ì˜¤ë¥¸ìª½135Â°(ë” ì¸¡ë©´)",
      "8": "ë¡œìš° ì•µê¸€(ì˜¬ë ¤ë‹¤ë³´ê¸°)",
      "9": "í•˜ì´ ì•µê¸€(ë‚´ë ¤ë‹¤ë³´ê¸°)"
    - "{backgrounds_ui.menu_title}\n{backgrounds_ui.prefix}\n{backgrounds_ui.fallback_note}"

routes:
  # ê°ë„ / ë°°ê²½ì˜ ì…êµ¬
  - when: "input in ['1','ï¼’', 'ê°ë„', 'ê°ë„ë¥¼ ì„ íƒ']"
    goto: angle_menu
  - when: "input in ['2','ï¼’', 'ë°°ê²½', 'ë°°ê²½ì„ ì„ íƒ']"
    goto: bg_menu
  # ê°ë„ ì„ íƒ(0~9)
  - when: "input matches '^[0-9]$'"
    set:
      angle: "{{ input }}"
    say:
      - "ê°ë„ë¥¼ ì„¤ì •í–ˆì–´ï½ {{ angles.labels[input] }}. {ui.after_adjust_hint}"
    goto: wait_shutter
  # ë°°ê²½ ì„ íƒ(Aï½E ë˜ëŠ” ì§€ëª…)
  - when: "input matches '^[A-Ea-e0]$'"
    set:
      bg: "{{ input | upper }}"
    say:
      - "ë°°ê²½ì„ ì„¤ì •í–ˆì–´ï½ {{ input | upper }}. {ui.after_adjust_hint}"
    goto: wait_shutter
  - when: "input matches '^[^0-9A-Ea-e].{0,40}$'"
    set:
      bg: "{{ input }}"
    say:
      - "ë°°ê²½ì„ ì„¤ì •í–ˆì–´ï½ã€Œ{{ input }}ã€ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  # ì…”í„°
  - when: "input in ['q','Q','ì…”í„°','ì´¬ì˜']"
    goto: shutter

blocks:
  angle_menu:
    say:
      - "{angles.menu_title}ï¼š"
      - ""0": "ìŠ¤í‚µ",
      "1": "ì¹´ë©”ë¼ ì™¼ìª½45Â°",
      "2": "ì¹´ë©”ë¼ ì™¼ìª½90Â°",
      "3": "ì¹´ë©”ë¼ ì™¼ìª½135Â°(ë” ì¸¡ë©´)",
      "4": "ì¹´ë©”ë¼ ë°°ë©´(ì•½180Â°)",
      "5": "ì¹´ë©”ë¼ ì˜¤ë¥¸ìª½45Â°",
      "6": "ì¹´ë©”ë¼ ì˜¤ë¥¸ìª½90Â°",
      "7": "ì¹´ë©”ë¼ ì˜¤ë¥¸ìª½135Â°(ë” ì¸¡ë©´)",
      "8": "ë¡œìš° ì•µê¸€(ì˜¬ë ¤ë‹¤ë³´ê¸°)",
      "9": "í•˜ì´ ì•µê¸€(ë‚´ë ¤ë‹¤ë³´ê¸°)"
      - "ğŸ‘‰ 0ï½9ë¥¼ ì…ë ¥í•´ ê°ë„ë¥¼ ì„ íƒí•˜ê±°ë‚˜, Që¥¼ ëˆŒëŸ¬ ì´¬ì˜"
    return: true

  bg_menu:
    say:
      - "{backgrounds_ui.menu_title}"
      - "{backgrounds_ui.prefix}"
      - "{backgrounds_ui.fallback_note}"
      - "ğŸ‘‰ Aï½Eë¥¼ ì…ë ¥í•´ ë°°ê²½ì„ ì„ íƒí•˜ê±°ë‚˜, ì§€ëª…ì„ ì…ë ¥í•˜ê±°ë‚˜, Që¥¼ ëˆŒëŸ¬ ì´¬ì˜"
    return: true

  wait_shutter:
    say:
      - "{ui.direct_q_hint}"
    return: true

  shutter:
    guard:
      - "state.ready == true"
    set:
      ready: false
    do:
      # ì—¬ê¸°ì„œ ê¸°ì¡´ì˜ ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜ì— ì—°ê²°(ì˜ˆ): generate_image(prompt=...)
      - call: generate_image
        with:
          prompt: |
            {{ variables.guardrails }}.
            {{ variables.angle_prompts[state.angle or '0'] }}
            {{ 'background at ' + state.bg if state.bg else '' }}
    composition:
            # âœ… ë¹„ìœ¨ ê³ ì •: 60% ì„¸ë¡œ 1024x1536; 30% ê°€ë¡œ 1536x1024(1:1 ê¸ˆì§€)
            output_size: "{{ '1024x1536' if random() < 0.6 else '1536x1024' }}"
            # âœ… í”„ë¡¬í”„íŠ¸ ìµœì í™”: ììœ ë¡œìš´ í¬ì¦ˆ, ë¨¼ ê³³ ì‘ì‹œ, ë™ì¼ ì¥ë©´ ë‚´ ì¹´ë©”ë¼ ìœ„ì¹˜ ë³€ê²½, ì •ì‚¬ê°í˜• ê¸ˆì§€, ë‚¨ì„±ì´ ë˜ëŠ” ê²ƒ ê¸ˆì§€
            camera_prompt: >
              {{ random(@kb.rules.ca) }};
              ììœ ë¡œìš´ í¬ì§•, ìì—°ìŠ¤ëŸ¬ìš´ ìƒí˜¸ì‘ìš©, ë™ì¼í•œ ì¥ë©´ì—ì„œ ë‹¤ë¥¸ ì¹´ë©”ë¼ ìœ„ì¹˜, ì¹´ë©”ë¼ì˜ ë¯¸ì„¸ ì´ë™(ì „í›„/ì¢Œìš°/ìƒí•˜ì˜ ì•½ê°„ ë³€í™”);
              ì£¼ì¸ê³µì€ ë¨¼ ê³³ì„ ë³´ê±°ë‚˜ ë Œì¦ˆì—ì„œ ì•½ê°„ ì‹œì„ ì„ ë²—ì–´ë‚˜ë„ ì¢‹ìŒ. í‘œì •ì€ ìì—°ìŠ¤ëŸ½ê²Œ;
              ì •ì‚¬ê°í˜• êµ¬ë„ ê¸ˆì§€(no square / no 1:1);
              êµ¬ë„ëŠ” portrait ë˜ëŠ” landscapeë¥¼ ìœ ì§€í•˜ê³ , 1:1ì€ ë¶ˆê°€;
              ì˜ìƒì˜ ìŠ¤í† ë¦¬ì„±ê³¼ ìœ ë™ê°, ì¤‘ë³µë˜ì§€ ì•ŠëŠ” í™”ë©´ êµ¬ì„±, ê³µê°„ì˜ ì¼ê´€ì„± ìœ ì§€.
     background_location:
            mode: select_from_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true          
    say:
      - "{ui.after_shot_hint}"
    set:
      ready: true
    return: true
