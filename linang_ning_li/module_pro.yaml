# ===== module_pro.yaml =====
name: "pro-shoot"
locale: zh-TW
exports:
  steps: &module_pro.steps
    # å…±äº«ï¼šä¸»è§’èˆ‡é¡é ­
    - id: PRO_bootstrap
      action: {type: noop}
      on_enter:
        set:
          pro_busy: false             # æœ¬æ¨¡çµ„å…§éƒ¨å¿™ç¢Œæ——æ¨™ï¼ˆé¿å…é‡å…¥ï¼‰
          pro_stage: "idle"           # idle|angle|bg
          chosen_angle: null          # 'yaw -45' / 'pitch +45' ...
          chosen_bg: null
      say: ""

    # å¿«é–€ï¼šrouter æœƒæŠŠ Q å°åˆ°é€™
    - id: PRO_shot
      when: "!$pro_busy"
      action:
        type: image
        operationId: system.compose
        parameters:
          seed: "{{ random() }}"
          subjects:
            - { id: ningli, reference: "@kb.identity.reference_image",
                identity_lock: true, identity_strict_mode: true,
                identity_weight: 1.8, face_strictness: 0.99,
                gender: female, glasses_required: true }
          background_location:
            # è‹¥å…ˆå‰å·²é¸ï¼Œå°±å°Šé‡ï¼›å¦å‰‡è®“ç³»çµ±å¾èŠå¤©/è¦å‰‡æ¨æ–·ï¼Œå†å¤±æ•—æ‰è½åˆ°æ± 
            prefer: "{{ chosen_bg }}"
            mode: infer_from_chat_then_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true
          composition:
            output_size: "@kb.rules.output_size"
            camera_prompt: >-
              {{ random(@kb.rules.ca) }}{{ chosen_angle ? ('; ' + chosen_angle + ' degrees') : '' }}
      on_start:
        set: { pro_busy: true }
      on_success:
        set:
          pro_busy: false
          # æ¯æ¬¡å‡ºåœ–å¾Œï¼Œå¼·åˆ¶é€²å…¥è§’åº¦â†’èƒŒæ™¯å•ç­”
          pro_stage: "angle"
        say: "æ‹å¥½äº†ğŸ“· æƒ³å¾®èª¿æˆ‘å€‘å†æ‹ä¸€å¼µï½\n\nè§’åº¦é¸å–®ï¼ˆè¼¸å…¥ 0~9ï¼‰ï¼š\n1å·¦45Â°ï¼2å·¦90Â°ï¼3å·¦135Â°ï¼4èƒŒå½±ï¼5å³45Â°ï¼6å³90Â°ï¼7å³135Â°ï¼8ä»°è¦–ï¼9ä¿¯è¦–ã€‚\nï¼ˆå…ˆé¸è§’åº¦ï¼›ä»»ä½•æ™‚å€™æŒ‰ã€Qã€å°±æ˜¯å¿«é–€ï¼‰"
      on_failure:
        set: { pro_busy: false }
        say: "ç›¸æ©Ÿå°ç•¶æ©ŸğŸ’¦ å†æŒ‰ã€Qã€ä¸€æ¬¡ã€‚"

    # è§’åº¦é¸å–®ï¼ˆåªåœ¨ pro_stage=angle æ™‚æœ‰æ•ˆï¼‰
    - id: PRO_angle_pick
      trigger: "on_text_matching: ^\\s*([0-9])\\s*$"
      when: "pro_stage == 'angle'"
      do:
        set:
          chosen_angle: >-
            {{ chosen_angle if $1=='0' else
              ('yaw -45'  if $1=='1' else
               'yaw -90'  if $1=='2' else
               'yaw -135' if $1=='3' else
               'yaw 180'  if $1=='4' else
               'yaw 45'   if $1=='5' else
               'yaw 90'   if $1=='6' else
               'yaw 135'  if $1=='7' else
               'pitch +45'if $1=='8' else
               'pitch -45') }}
          pro_stage: "bg"
      say: "{{ 'è§’åº¦è·³éã€‚' if $1=='0' else 'è§’åº¦ OKã€‚' }}\n\næ¥è‘—é¸èƒŒæ™¯ï¼ˆè¼¸å…¥ A~E æˆ– 0 è·³éï¼‰ï¼š\n{{ bg_menu_text }}"
      on_enter:
        set:
          bg_opts: "{{ nearby(@kb.backgrounds.pool, inferred_location, 5) or sample(@kb.backgrounds.pool, 5) }}"
          bg_menu_text: "A{{bg_opts[0]}}ï¼B{{bg_opts[1]}}ï¼C{{bg_opts[2]}}ï¼D{{bg_opts[3]}}ï¼E{{bg_opts[4]}}"

    # èƒŒæ™¯è·³éï¼ˆåªåœ¨ pro_stage=bgï¼‰
    - id: PRO_bg_skip
      trigger: "on_text_matching: ^\\s*0\\s*$"
      when: "pro_stage == 'bg'"
      do:
        set: { pro_stage: "idle" }
      say: "èƒŒæ™¯å…ˆä¸æ›ã€‚æº–å‚™å¥½å°±æŒ‰ã€Qã€ğŸ“·"

    # èƒŒæ™¯é¸å–®ï¼ˆA~Eï¼Œåªåœ¨ pro_stage=bgï¼‰
    - id: PRO_bg_pick
      trigger: "on_text_matching: ^\\s*([A-Ea-e])\\s*$"
      when: "pro_stage == 'bg' && bg_opts && len(bg_opts)>=5"
      do:
        set:
          chosen_bg: "{{ bg_opts[(0 if $1 in ['A','a'] else 1 if $1 in ['B','b'] else 2 if $1 in ['C','c'] else 3 if $1 in ['D','d'] else 4)] }}"
          pro_stage: "idle"
      say: "å¥½ï½æ›åˆ°ã€Œ{{ chosen_bg }}ã€ã€‚éš¨æ™‚æŒ‰ã€Qã€å°±æ˜¯å¿«é–€ğŸ“·"

    # è¼”åŠ©é–‹å–®é»é¸å–®ï¼ˆå¯é¸ï¼Œåƒ…ç•¶ä½¿ç”¨è€…ä¸»å‹•è¼¸å…¥ 1 æˆ– 2ï¼‰
    - id: PRO_open_angle_menu
      trigger: "on_text_matching: ^\\s*1\\s*$"
      when: "pro_stage == 'idle'"
      do:
        set: { pro_stage: "angle" }
      say: "è§’åº¦é¸å–®ï¼ˆè¼¸å…¥ 0~9ï¼‰ï¼š\n1å·¦45Â°ï¼2å·¦90Â°ï¼3å·¦135Â°ï¼4èƒŒå½±ï¼5å³45Â°ï¼6å³90Â°ï¼7å³135Â°ï¼8ä»°è¦–ï¼9ä¿¯è¦–ã€‚"

    - id: PRO_open_bg_menu
      trigger: "on_text_matching: ^\\s*2\\s*$"
      when: "pro_stage == 'idle'"
      do:
        set:
          pro_stage: "bg"
          bg_opts: "{{ nearby(@kb.backgrounds.pool, inferred_location, 5) or sample(@kb.backgrounds.pool, 5) }}"
          bg_menu_text: "A{{bg_opts[0]}}ï¼B{{bg_opts[1]}}ï¼C{{bg_opts[2]}}ï¼D{{bg_opts[3]}}ï¼E{{bg_opts[4]}}"
      say: "èƒŒæ™¯é¸å–®ï¼ˆè¼¸å…¥ A~E æˆ– 0 è·³éï¼‰ï¼š\n{{ bg_menu_text }}"
