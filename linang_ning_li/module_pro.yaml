name: module_pro
version: "1.0"
locale: zh-TW

# å°ˆæ‹ï¼ˆå¥³ä¸»å–®æ‹ï¼‰ç‹€æ…‹æ¬„ä½ï¼ˆç”± router åˆå§‹åŒ–ä¸€æ¬¡å³å¯ï¼‰
state:
  pro_stage: "idle"       # idle|angle|bg
  chosen_angle: null      # ä¾‹å¦‚ 'yaw -45' / 'pitch +45'
  chosen_bg: null         # æ–‡æœ¬åœ°é»
  bg_opts: []             # èƒŒæ™¯å€™é¸ A~E
  busy: false

steps:
# å…¥å£ï¼šå•Ÿç”¨å°ˆæ‹ï¼ˆä¸é€²é¸å–®ï¼Œè®“ä½¿ç”¨è€…å¯ç›´æ¥ Qï¼‰
- id: PRO_on
  trigger: "on_text_matching: ^\\s*(æ‹ç…§|å¹«ä½ æ‹|å¥³ä¸»æ‹)\\s*$"
  when: "!$busy"
  do:
    set:
      pro_stage: "idle"
    say: |
      {{ kb.phrases.ui.pro_on or "æƒ³å¹«æˆ‘æ‹å—ï¼Ÿç›´æ¥æŒ‰ã€Qã€å…ˆä¾†ä¸€å¼µï½ï¼ˆæˆ–ï¼šæŒ‰ã€1ã€è§’åº¦ã€æŒ‰ã€2ã€èƒŒæ™¯ï¼‰" }}

# ç”±ç¸½å¿«é–€è·¯ç”±é€²ä¾†çš„å‡ºåœ–æ­¥é©Ÿï¼ˆrouter æœƒ set busy:true å¾Œ goto åˆ°é€™ï¼‰
- id: PRO_shot
  action:
    type: image
    operationId: system.compose
    parameters:
      seed: "{{ kb.rules.seed or random() }}"
      subjects:
        - reference: "{{ kb.identity.reference_image }}"
          identity_lock: true
          identity_strict_mode: true
          gender: female
          glasses_required: true
      background_location:
        prefer: "{{ chosen_bg }}"
        # å…ˆç”¨èŠå¤©/èªå¢ƒæ¨æ–·ï¼Œå¤±æ•—å°±å¾å°ç£æ± æˆ–ä½ è‡ªè¨‚ backgrounds è£œ
        mode: infer_from_chat_then_pool
        region_hint: Taiwan
        require_match: true
        fallback_pool: "{{ kb.backgrounds.pool or kb.rules.tw_pool }}"
        randomize: true
      composition:
        output_size: "{{ kb.rules.output_size or '1024x1536' }}"
        camera_prompt: "{{ (kb.rules.camera or '85mm') + (chosen_angle and ('; ' + chosen_angle + ' degrees') or '') }}"
        selfie_style: true
        no_extra_people: true
        subject_crop: waist_up
        remove_subject_background: true
        use_source_background: false
  on_success:
    # å…ˆè§£é™¤ busyï¼Œé¿å… when: "!$busy" æ“‹ä½å¾ŒçºŒé¸å–®
    set:
      busy: false
    # ç¬¬ 1 å¼µèˆ‡å¾ŒçºŒéƒ½çµ±ä¸€é€²è§’åº¦é¸å–®ï¼ˆåŒæ™‚å‡º first_shot_hintï¼‰
    goto: PRO_show_angle_menu
  on_failure:
    set:
      busy: false
    say: "{{ kb.phrases.errors.retry or 'ç›¸æ©Ÿå°ç•¶æ©ŸğŸ’¦ å†æŒ‰ã€Qã€è©¦ä¸€æ¬¡ã€‚' }}"

# â€”â€” è§’åº¦é¸å–® â€”â€” #
# å¿«æ·ï¼šæŒ‰ 1 ç›´æ¥æ‰“é–‹è§’åº¦é¸å–®
- id: PRO_angle_menu_quick
  trigger: "on_text_matching: ^\\s*1\\s*$"
  when: "!$busy"
  do:
    goto: PRO_show_angle_menu

# é¡¯ç¤ºè§’åº¦é¸å–®ï¼ˆé¦–å¼µæˆ–ä¹‹å¾Œéƒ½èƒ½å‘¼å«ï¼‰
- id: PRO_show_angle_menu
  action:
    type: noop
  on_enter:
    set:
      pro_stage: "angle"
  say: |
    {{ kb.phrases.ui.first_shot_hint or "æ‹å¥½äº†ğŸ“· æƒ³å¾®èª¿ï¼šè¼¸å…¥ã€1ã€è§’åº¦ï¼ã€2ã€èƒŒæ™¯ï¼›éš¨æ™‚æŒ‰ã€Qã€å¿«é–€ã€‚" }}

    {{ kb.phrases.angles.menu_title or "è§’åº¦é¸å–®ï¼ˆè¼¸å…¥ 0ï½9ï¼›0 è·³éï¼‰" }}
    0. {{ kb.phrases.angles.labels["0"] or "è·³é" }}
    1. {{ kb.phrases.angles.labels["1"] or "å·¦45Â°" }}
    2. {{ kb.phrases.angles.labels["2"] or "å·¦90Â°" }}
    3. {{ kb.phrases.angles.labels["3"] or "å·¦135Â°" }}
    4. {{ kb.phrases.angles.labels["4"] or "èƒŒå½±" }}
    5. {{ kb.phrases.angles.labels["5"] or "å³45Â°" }}
    6. {{ kb.phrases.angles.labels["6"] or "å³90Â°" }}
    7. {{ kb.phrases.angles.labels["7"] or "å³135Â°" }}
    8. {{ kb.phrases.angles.labels["8"] or "ä»°è¦–" }}
    9. {{ kb.phrases.angles.labels["9"] or "ä¿¯è¦–" }}

    ğŸ‘‰ è‹¥è¦æ›èƒŒæ™¯ï¼šè¼¸å…¥ã€Œ2ã€é–‹å–®ï¼›éš¨æ™‚æŒ‰ã€Qã€å¿«é–€ã€‚

# è§’åº¦æ•¸å­— 0~9ï¼ˆåƒ…åœ¨è§’åº¦éšæ®µç”Ÿæ•ˆï¼‰
- id: PRO_angle_pick
  trigger: "on_text_matching: ^\\s*([0-9])\\s*$"
  when: "!$busy && pro_stage == 'angle'"
  do:
    set:
      chosen_angle: >-
        {{ 
          'null' if $1=='0' else
          'yaw -45'  if $1=='1' else
          'yaw -90'  if $1=='2' else
          'yaw -135' if $1=='3' else
          'yaw 180'  if $1=='4' else
          'yaw 45'   if $1=='5' else
          'yaw 90'   if $1=='6' else
          'yaw 135'  if $1=='7' else
          'pitch +45'if $1=='8' else
          'pitch -45'
        }}
      pro_stage: "idle"
    say: |
      {{ 'å…ˆè·³éè§’åº¦ã€‚' if $1=='0' else (kb.phrases.angles.ok or 'è§’åº¦OKã€‚') }}
      æƒ³æ›èƒŒæ™¯å¯è¼¸å…¥ã€2ã€ï¼›éš¨æ™‚æŒ‰ã€Qã€å¿«é–€ã€‚

# â€”â€” èƒŒæ™¯é¸å–® â€”â€” #
# å¿«æ·ï¼šæŒ‰ 2 ç›´æ¥æ‰“é–‹èƒŒæ™¯é¸å–®
- id: PRO_bg_menu_quick
  trigger: "on_text_matching: ^\\s*2\\s*$"
  when: "!$busy"
  do:
    set:
      bg_opts: "{{ kb.rules.nearby_pool or sample(kb.backgrounds.pool or kb.rules.tw_pool, 5) }}"
      pro_stage: "bg"
    say: |
      {{ kb.phrases.background.menu_title or "èƒŒæ™¯é¸å–®ï¼ˆè¼¸å…¥ A~E æˆ– 0 è·³éï¼‰" }}
      0. {{ kb.phrases.background.skip or "è·³é" }}
      A. {{ bg_opts[0] if bg_opts and len(bg_opts)>0 else 'å°åŒ—101å‘¨é‚Š' }}
      B. {{ bg_opts[1] if bg_opts and len(bg_opts)>1 else 'è¥¿é–€ç”ºç´…æ¨“' }}
      C. {{ bg_opts[2] if bg_opts and len(bg_opts)>2 else 'è¯å±±1914æ–‡å‰µåœ’å€' }}
      D. {{ bg_opts[3] if bg_opts and len(bg_opts)>3 else 'æ¾å±±æ–‡å‰µåœ’å€' }}
      E. {{ bg_opts[4] if bg_opts and len(bg_opts)>4 else 'è±¡å±±æ­¥é“' }}

# å‚³çµ±æŒ‡ä»¤ï¼šè¼¸å…¥ã€ŒèƒŒæ™¯ã€ä¹Ÿèƒ½é–‹é¸å–®
- id: PRO_bg_menu_cmd
  trigger: "on_text_matching: ^\\s*èƒŒæ™¯\\s*$"
  when: "!$busy"
  do:
    set:
      bg_opts: "{{ kb.rules.nearby_pool or sample(kb.backgrounds.pool or kb.rules.tw_pool, 5) }}"
      pro_stage: "bg"
    say: |
      {{ kb.phrases.background.menu_title or "èƒŒæ™¯é¸å–®ï¼ˆè¼¸å…¥ A~E æˆ– 0 è·³éï¼‰" }}
      0. {{ kb.phrases.background.skip or "è·³é" }}
      A. {{ bg_opts[0] if bg_opts and len(bg_opts)>0 else 'å°åŒ—101å‘¨é‚Š' }}
      B. {{ bg_opts[1] if bg_opts and len(bg_opts)>1 else 'è¥¿é–€ç”ºç´…æ¨“' }}
      C. {{ bg_opts[2] if bg_opts and len(bg_opts)>2 else 'è¯å±±1914æ–‡å‰µåœ’å€' }}
      D. {{ bg_opts[3] if bg_opts and len(bg_opts)>3 else 'æ¾å±±æ–‡å‰µåœ’å€' }}
      E. {{ bg_opts[4] if bg_opts and len(bg_opts)>4 else 'è±¡å±±æ­¥é“' }}

# èƒŒæ™¯ï¼š0 è·³éï¼ˆåƒ…åœ¨èƒŒæ™¯éšæ®µç”Ÿæ•ˆï¼‰
- id: PRO_bg_skip
  trigger: "on_text_matching: ^\\s*0\\s*$"
  when: "!$busy && pro_stage == 'bg'"
  do:
    set:
      pro_stage: "idle"
    say: "{{ kb.phrases.background.skip_ok or 'å…ˆä¸æ›èƒŒæ™¯ã€‚æº–å‚™å¥½å°±æŒ‰ã€Qã€ğŸ“·' }}"

# èƒŒæ™¯ï¼šA~E é¸ä¸€å€‹ï¼ˆåƒ…åœ¨èƒŒæ™¯éšæ®µç”Ÿæ•ˆï¼‰
- id: PRO_bg_pick
  trigger: "on_text_matching: ^\\s*([A-Ea-e])\\s*$"
  when: "!$busy && pro_stage == 'bg' && bg_opts && len(bg_opts)>=1"
  do:
    set:
      chosen_bg: "{{ bg_opts[ (0 if $1 in ['A','a'] else 1 if $1 in ['B','b'] else 2 if $1 in ['C','c'] else 3 if $1 in ['D','d'] else 4) ] }}"
      pro_stage: "idle"
    say: |
      {{ (kb.phrases.background.ok or 'å¥½ï½èƒŒæ™¯æ›æˆ') + ' ' + chosen_bg + 'ã€‚' }}
      æº–å‚™å¥½å°±æŒ‰ã€Qã€æ‹ğŸ“·

