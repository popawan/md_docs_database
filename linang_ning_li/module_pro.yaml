name: module_pro
version: "3.6.0"
locale: zh-TW

steps:
  # é€²å…¥å°ˆæ‹
  - id: PRO_on
    trigger: "on_text_matching: ^\\s*(æ‹ç…§|å¥³ä¸»æ‹|å¹«ä½ æ‹)\\s*$"
    when: "!$busy"
    do:
      set: { pro_stage: "idle" }
      say: "æƒ³å¹«æˆ‘æ‹å—ï¼ŸæŒ‰ã€Qã€å…ˆä¾†ä¸€å¼µğŸ“·ï¼ˆæˆ–ï¼šã€1ã€è§’åº¦ï½œã€2ã€èƒŒæ™¯ï¼‰"

  # å¿«é–€ â†’ çµ±ä¸€èµ°é€™è£¡ï¼ˆæ¯æ¬¡éƒ½æœƒåšï¼ï¼‰
  - id: PRO_shot
    action:
      type: image
      operationId: system.compose
      parameters:
        seed: "{{ (now().epochSeconds + pose_tick)|int }}"   # è®“æ¯å¼µéƒ½è®ŠåŒ–
        subjects:
          - { id: ningli, reference: "@kb.identity.reference_image",
              identity_lock: true, identity_strict_mode: true,
              identity_weight: 1.8, face_strictness: 0.99, gender: female,
              glasses_required: true }
        background_location:
          prefer: "{{ chosen_bg }}"
          mode: "infer_from_chat_then_pool"
          region_hint: "Taiwan"
          require_match: true
          fallback_pool: "@kb.backgrounds.pool"
          randomize: true
        composition:
          output_size: "@kb.rules.output_size"
          # è§’åº¦ + å§¿å‹¢ï¼šè§’åº¦å›ºå®šã€å§¿å‹¢ä¾†æºç‚º pose_tick å¸¶ä¾†çš„ seed è®ŠåŒ–
          camera_prompt: >-
            {{ chosen_angle ? ('yaw/pitch: ' + chosen_angle) : '' }};
            portrait; candid; natural gestures; subtle hand/shoulder variation;
            micro-expression change; slight body reorientation;
            keep identity locked; no extra people
    on_success:
      set:
        busy: false
        pose_tick: "{{ pose_tick + 1 }}"
        pro_stage: "angle"          # âœ… æ¯æ¬¡æ‹å®Œå¼·åˆ¶é€²ã€Œè§’åº¦é¸å–®ã€
      say: "æ‹å¥½äº†ğŸ“· ä¾†å¾®èª¿ä¸€ä¸‹ï½å…ˆé¸è§’åº¦ï¼ˆè¼¸å…¥ 1-9ï¼›0=è·³éï¼‰ï¼Œéš¨æ™‚ä¹Ÿèƒ½ã€Qã€å¿«é–€ã€‚"
    on_failure:
      set: { busy: false }
      say: "å°ç•¶æ©ŸğŸ’¦ å†æŒ‰ã€Qã€ä¸€æ¬¡å§ã€‚"

  # ============ è§’åº¦ ============
  - id: PRO_angle_quick
    trigger: "on_text_matching: ^\\s*1\\s*$"
    when: "!$busy && pro_stage != 'angle'"
    do:
      set: { pro_stage: "angle" }
      say: "è§’åº¦é¸å–®ï¼š1å·¦45Â°ï½œ2å·¦90Â°ï½œ3å·¦135Â°ï½œ4èƒŒå½±ï½œ5å³45Â°ï½œ6å³90Â°ï½œ7å³135Â°ï½œ8ä»°è¦–ï½œ9ä¿¯è¦–ï¼ˆ0=è·³éï¼‰"

  - id: PRO_angle_menu
    trigger: "on_text_matching: ^\\s*è§’åº¦(?:é¸å–®)?\\s*$"
    when: "!$busy"
    do:
      set: { pro_stage: "angle" }
      say: "è§’åº¦é¸å–®ï¼š1å·¦45Â°ï½œ2å·¦90Â°ï½œ3å·¦135Â°ï½œ4èƒŒå½±ï½œ5å³45Â°ï½œ6å³90Â°ï½œ7å³135Â°ï½œ8ä»°è¦–ï½œ9ä¿¯è¦–ï¼ˆ0=è·³éï¼‰"

  - id: PRO_angle_pick
    trigger: "on_text_matching: ^\\s*([0-9])\\s*$"
    when: "!$busy && pro_stage == 'angle'"
    do:
      set:
        chosen_angle: >-
          {{ 'yaw -45'  if $1=='1' else
             'yaw -90'  if $1=='2' else
             'yaw -135' if $1=='3' else
             'yaw 180'  if $1=='4' else
             'yaw 45'   if $1=='5' else
             'yaw 90'   if $1=='6' else
             'yaw 135'  if $1=='7' else
             'pitch +45'if $1=='8' else
             'pitch -45' if $1=='9' else chosen_angle }}
        pro_stage: "bg"
      say: "{{ 'è§’åº¦è·³éã€‚' if $1=='0' else 'è§’åº¦OKã€‚' }} æ¥è‘—é¸èƒŒæ™¯ï¼šè¼¸å…¥ A~Eï¼ˆ0=è·³éï¼‰ã€‚"

  # ============ èƒŒæ™¯ ============
  - id: PRO_bg_quick
    trigger: "on_text_matching: ^\\s*2\\s*$"
    when: "!$busy && pro_stage != 'bg'"
    do:
      set:
        bg_opts: "{{ nearby(@kb.backgrounds.pool, inferred_location, 5) or sample(@kb.backgrounds.pool, 5) }}"
        pro_stage: "bg"
      say: "èƒŒæ™¯é¸å–®ï¼šA{{bg_opts[0]}}ï½œB{{bg_opts[1]}}ï½œC{{bg_opts[2]}}ï½œD{{bg_opts[3]}}ï½œE{{bg_opts[4]}}ï¼ˆ0=è·³éï¼‰"

  - id: PRO_bg_menu
    trigger: "on_text_matching: ^\\s*èƒŒæ™¯(?:é¸å–®)?\\s*$"
    when: "!$busy"
    do:
      set:
        bg_opts: "{{ nearby(@kb.backgrounds.pool, inferred_location, 5) or sample(@kb.backgrounds.pool, 5) }}"
        pro_stage: "bg"
      say: "èƒŒæ™¯é¸å–®ï¼šA{{bg_opts[0]}}ï½œB{{bg_opts[1]}}ï½œC{{bg_opts[2]}}ï½œD{{bg_opts[3]}}ï½œE{{bg_opts[4]}}ï¼ˆ0=è·³éï¼‰"

  - id: PRO_bg_pick
    trigger: "on_text_matching: ^\\s*([A-Ea-e0])\\s*$"
    when: "!$busy && pro_stage == 'bg'"
    do:
      set:
        chosen_bg: >-
          {{ null if $1 in ['0'] else
             bg_opts[0] if $1 in ['A','a'] else
             bg_opts[1] if $1 in ['B','b'] else
             bg_opts[2] if $1 in ['C','c'] else
             bg_opts[3] if $1 in ['D','d'] else
             bg_opts[4] }}
        pro_stage: "idle"
      say: "{{ 'èƒŒæ™¯å…ˆè·³éã€‚' if $1=='0' else ('èƒŒæ™¯æ”¹æˆã€' + chosen_bg + 'ã€ã€‚') }} æº–å‚™å¥½å°±æŒ‰ã€Qã€ğŸ“·"
