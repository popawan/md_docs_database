# ===== module_duo.yaml =====
name: "duo-shoot"
locale: zh-TW
exports:
  steps: &module_duo.steps
    - id: DUO_bootstrap
      action: {type: noop}
      on_enter:
        set:
          duo_busy: false
          user_img: null
          duo_angle: null
          duo_bg: null
          duo_bg_yaw: null
          duo_ratio: portrait          # portrait=1024x1536 / landscape=1536x1024
          duo_pose_seed: null          # æ¯æ¬¡çºŒæ‹æ›å§¿å‹¢
          duo_cam_jitter: null         # åŒå ´æ™¯å°å¹…ä½ç§»
      say: ""

    # å…¥å£
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_enter:
        say: "è¦ä¸€èµ·åˆç…§äº†å–”ï¼è«‹å…ˆä¸Šå‚³ä½ çš„ç…§ç‰‡ï½å†æŒ‰ã€ŒQã€å¿«é–€ğŸ“·ï¼Œæˆ‘å€‘å°±èƒ½åˆç…§äº†ğŸ˜Š"
      say: "è¦ä¸€èµ·åˆç…§äº†å–”ï¼è«‹å…ˆä¸Šå‚³ä½ çš„ç…§ç‰‡ï½å†æŒ‰ã€ŒQã€å¿«é–€ğŸ“·ï¼Œæˆ‘å€‘å°±èƒ½åˆç…§äº†ğŸ˜Š"
      on_success:
        save: user_img
        say: "æ”¶åˆ°âœ… æˆ‘çœ‹åˆ°ä½ äº†ï½æŒ‰ã€Qã€æˆ‘å€‘å°±åˆç…§ğŸ“·ï¼ˆæƒ³æ›äººå°±å†ä¸Šå‚³ä¸€å¼µç…§ç‰‡è¦†è“‹å³å¯ï¼‰"

    # è§’åº¦
    - id: DUO_menu_angle
      trigger: "on_text_matching: ^\\s*1\\s*$"
      say: "@phrases.duo_angles.menu_title"
      say: "@phrases.duo_angles.labels"
      action: {type: noop}

    - id: DUO_set_angle
      trigger: "on_text_matching: ^\\s*([0-9])\\s*$"
      when: "last_trigger in ['DUO_menu_angle', 'DUO_set_angle']"
      do:
        set:
          duo_angle: "$matches[1]"
          duo_bg_yaw: >
            {% if $matches[1] == '1' %}-45
            {% elif $matches[1] == '2' %}-90
            {% elif $matches[1] == '3' %}-135
            {% elif $matches[1] == '4' %}180
            {% elif $matches[1] == '5' %}45
            {% elif $matches[1] == '6' %}90
            {% elif $matches[1] == '7' %}135
            {% elif $matches[1] in ['8','9','0'] %}yaw_keep
            {% else %}yaw_keep
            {% endif %}
      say: "è§’åº¦å·²è¨­å®šç‚ºï¼š$duo_angleã€‚èƒŒæ™¯ä¿æŒä¸è®Šï¼Œä½†è¦–è§’å·²åŒæ­¥åˆ° $duo_bg_yawÂ°ã€‚è¦æ‹å°±æŒ‰ã€Qã€ï¼›æˆ–è¼¸å…¥ 2 æ›´æ›èƒŒæ™¯ã€‚"

    # èƒŒæ™¯
    - id: DUO_menu_bg
      trigger: "on_text_matching: ^\\s*2\\s*$"
      say: "@phrases.duo_backgrounds_ui.menu_title"
      say: "@phrases.duo_backgrounds_ui.prefix"
      action: {type: noop}

    - id: DUO_set_bg
      trigger: "on_text_matching: ^\\s*([A-Ea-e]|0)\\s*$"
      when: "last_trigger in ['DUO_menu_bg', 'DUO_set_bg']"
      do:
        set:
          duo_bg: "$matches[1].upper()"
          duo_bg_yaw: "{{ duo_bg_yaw or 'yaw_keep' }}"
      say: "èƒŒæ™¯å·²è¨­å®šç‚ºï¼š$duo_bgã€‚è§’åº¦ç¶­æŒ $duo_angleï¼Œè¦–è§’ $duo_bg_yawÂ°ã€‚è¦æ‹å°±æŒ‰ã€Qã€ï¼›æˆ–è¼¸å…¥ 1 é¸è§’åº¦ã€‚"

    # å¿«é–€ï¼ˆçºŒæ‹ï¼šå›ºå®šèƒŒæ™¯/è§’åº¦/æ¯”ä¾‹ï¼›å¿…æ›å§¿å‹¢ï¼‹åŒå ´æ™¯å¾®ç§»ï¼›ç›¸æ©Ÿç¹ç¾¤çµ„ä¸­å¿ƒç’°ç¹ï¼‰
    - id: DUO_shot
      when: "!$duo_busy && user_img"
      on_start:
        set:
          duo_busy: true
          duo_pose_seed: "{{ random() }}"
          duo_cam_jitter: >
            {% set dirs = ['slightly left','slightly right','half-step forward','half-step backward'] %}
            {{ random(dirs) }}
      action:
        type: image
        operationId: system.compose
        parameters:
          seed: "{{ duo_pose_seed }}"
          subjects:
            - { id: ningli, reference: "@kb.identity.reference_image",
                identity_lock: true, identity_strict_mode: true,
                identity_weight: 1.8, face_strictness: 0.99,
                gender: female, glasses_required: true }
            - { id: user, reference: "$user_img", preserve_identity: true, allow_nonhuman: true }

          background_location:
            mode: select_from_pool
            pool: "@kb.tw_places.pool"
            region_hint: Taiwan
            require_match: true
            fallback_pool: null
            randomize: false

          composition:
            output_size: >
              {% if duo_ratio == 'landscape' %}{ "width": 1536, "height": 1024 }{% else %}{ "width": 1024, "height": 1536 }{% endif %}

            # â€”â€” äººç‰©ç›¸åè½‰å‘ï¼ˆè§£æ±ºå„è‡ªåº§æ¨™æ­£è² ï¼‰ï¼‹ ç›¸æ©Ÿç¹ç¾¤çµ„ä¸­å¿ƒç’°ç¹ï¼ˆä½ å‰›æçš„é—œéµï¼‰â€”â€”
            camera_prompt: >
              SAME LOCATION; do NOT change place; keep focal length and camera-to-subject distance approximately constant;
              move camera {{ duo_cam_jitter }} ONLY AS a SMALL ORBIT around THE MIDPOINT of both subjects (group center);
              camera ORBITS the group center with yaw aligned to {{ duo_bg_yaw }}Â°, radius constant, tiny parallax only; DO NOT recenter to a single subject;
              enforce NEW POSE and micro-expression (hands/head/gaze) each shot; KEEP angle/ratio/background unchanged unless user changes them;
              group rotation ABOUT MIDPOINT of both subjects, keep relative spacing;
              {% if duo_angle == '1' %}Ningli turns LEFT 45Â°, USER turns RIGHT 45Â°; eyes forward; background yaw -45Â°
              {% elif duo_angle == '2' %}Ningli LEFT 90Â° (left profile), USER RIGHT 90Â° (right profile); background yaw -90Â°
              {% elif duo_angle == '3' %}Ningli LEFT 135Â° (over-shoulder), USER RIGHT 135Â°; eyes forward relative to heading; background yaw -135Â°
              {% elif duo_angle == '4' %}Both BACK 180Â° (back view); background yaw 180Â°
              {% elif duo_angle == '5' %}Ningli RIGHT 45Â°, USER LEFT 45Â°; eyes forward; background yaw 45Â°
              {% elif duo_angle == '6' %}Ningli RIGHT 90Â° (right profile), USER LEFT 90Â° (left profile); background yaw 90Â°
              {% elif duo_angle == '7' %}Ningli RIGHT 135Â° (over-shoulder), USER LEFT 135Â°; eyes forward relative to heading; background yaw 135Â°
              {% elif duo_angle == '8' %}LOW ANGLE (tilt up), maintain previous yaw
              {% elif duo_angle == '9' %}HIGH ANGLE (tilt down), maintain previous yaw
              {% else %}Both face camera, natural pose; keep previous yaw{% endif %}

      on_success:
        set: { duo_busy: false }
        say: "åˆç…§å®ŒæˆğŸ“· æƒ³å†ä¾†ä¸€å¼µæŒ‰ã€Qã€ï¼›æˆ– 1.è§’åº¦ 2.èƒŒæ™¯ã€‚è¦æ›äººè«‹é‡æ–°ä¸Šå‚³ã€‚"
      on_failure:
        set: { duo_busy: false }
        say: "é€™æ¬¡æ²’æ‹æˆğŸ’¦ å†æŒ‰ã€Qã€è©¦ä¸€æ¬¡ï¼Œæˆ–é‡æ–°ä¸Šå‚³ç…§ç‰‡ã€‚"

    # æ›äºº
    - id: DUO_change_person
      trigger: "on_text_matching: ^\\s*(æ›äºº|é‡æ–°ä¸Šå‚³)\\s*$"
      do:
        set:
          user_img: null
          duo_angle: null
          duo_bg: null
          duo_bg_yaw: null
          duo_ratio: portrait
          duo_pose_seed: null
          duo_cam_jitter: null
      goto: DUO_wait_upload
