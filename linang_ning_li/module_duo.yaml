# ===== module_duo.yaml =====
name: "duo-shoot"
locale: zh-TW

exports:
  steps: &module_duo.steps
    # å•Ÿå‹•ï¼šé‡ç½®ç‹€æ…‹
    - id: DUO_bootstrap
      action: { type: noop }
      on_enter:
        set:
          duo_busy: false
          user_img: null
      say: ""

    # å…¥å£ï¼ˆrouter æœƒæŠŠã€Œåˆç…§ã€å°åˆ°é€™ï¼‰
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_success:
        save: user_img
        say: "æ”¶åˆ°âœ… æˆ‘çœ‹åˆ°ä½ äº†ï½æŒ‰ã€Qã€æˆ‘å€‘å°±åˆç…§ğŸ“·\nï¼ˆæƒ³æ›äººå°±å†ä¸Šå‚³ä¸€å¼µç…§ç‰‡è¦†è“‹å³å¯ï¼‰"

    # å¿«é–€ï¼ˆrouter çš„ Q æœƒè·¯ç”±åˆ°é€™ï¼‰
    - id: DUO_shot
      when: "!$duo_busy && user_img"
      action:
        type: image
        operationId: system.compose
        parameters:
          seed: "{{ random() }}"
          subjects:
            # å¥³ä¸»å›ºå®šèº«ä»½ï¼ˆåš´æ ¼è‡‰éƒ¨æ ¡å°ï¼‰
            - { id: ningli, reference: "@kb.identity.reference_image",
                identity_lock: true, identity_strict_mode: true,
                identity_weight: 1.8, face_strictness: 0.99,
                gender: female, glasses_required: true }

            # ä½¿ç”¨è€…ç…§ç‰‡ï¼šæ¢å¾©ã€Œä¸æ‹˜ã€ï¼Œå…è¨±éäººåƒ
            - { id: user, reference: "$user_img",
                preserve_identity: true,
                allow_nonhuman: true }

          background_location:
            mode: select_from_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true

          composition:
            # ä»ç”± KB è¦å‰‡æ±ºå®šè¼¸å‡ºå°ºå¯¸ï¼ˆåå¥½ 1024Ã—1536 / 1536Ã—1024ã€é¿å… 1:1ï¼‰
            output_size: "@kb.rules.output_size"
            # æ”å½±æ©Ÿæç¤ºäº¤çµ¦è¦å‰‡æ± ï¼ˆå«è‡ªç”±æ“ºæ‹ã€çœ‹å‘é æ–¹ç­‰ï¼‰
            camera_prompt: "{{ random(@kb.rules.ca) }}"

      on_start:
        set: { duo_busy: true }

      on_success:
        set: { duo_busy: false }
        say: "åˆç…§å®ŒæˆğŸ“· æƒ³å†ä¾†ä¸€å¼µæŒ‰ã€Qã€ï¼›æˆ– 1.æ”å½±è§’åº¦ 2.èƒŒæ™¯ã€‚è¦æ›äººè«‹é‡æ–°ä¸Šå‚³ã€‚"

      on_failure:
        set: { duo_busy: false }
        say: "é€™æ¬¡æ²’æ‹æˆğŸ’¦ å†æŒ‰ã€Qã€è©¦ä¸€æ¬¡ï¼Œæˆ–é‡æ–°ä¸Šå‚³ç…§ç‰‡ã€‚"

    # è¼”åŠ©ï¼šæ‰‹å‹•æ›äººï¼ˆè¼¸å…¥ï¼šæ›äºº / é‡æ–°ä¸Šå‚³ï¼‰
    - id: DUO_change_person
      trigger: "on_text_matching: ^\\s*(æ›äºº|é‡æ–°ä¸Šå‚³)\\s*$"
      do:
        set: { user_img: null }
      goto: DUO_wait_upload
