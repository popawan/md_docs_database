module: module_duo
state:
  duo_pending: false
  duo_ready: false
  duo_retry: 0
  user_img: null

engine_subjects: &DUO_SUBJ
  - { id: ningli,
      reference: "@kb.identity.reference_image",
      identity_lock: true, identity_strict_mode: true,
      identity_weight: "@kb.identity.identity_weight",
      face_strictness: "@kb.identity.face_strictness",
      gender: female, glasses_required: true }

engine_comp: &DUO_COMP
  output_size: "@kb.layout_rules.default_portrait"
  camera_prompt: "35mm; waist_up; neutral pose; even light"

steps:
  - id: DUO_start
    trigger: "on_text_matching: ^\\s*(åˆç…§|ä¸€èµ·æ‹|æ‰¾æˆ‘åˆç…§|åˆå½±)\\s*$"
    when: "!$busy"
    do:
      set: { duo_pending: true, duo_ready: false, user_img: null }
      say: "å¥½å‘€ï½å…ˆä¸Šå‚³ä½ çš„ç…§ç‰‡ï¼Œæˆ‘å€‘æ‰èƒ½åˆç…§å–”ğŸ“¸"

  - id: DUO_wait
    action: { type: wait_for_file, accept: ["image/*"] }
    on_success:
      save: user_img
      set: { duo_ready: true, duo_pending: false }
      say: "æˆ‘çœ‹åˆ°ä½ äº†ï½ç¾åœ¨æŒ‰ã€Qã€å°±èƒ½åˆç…§ğŸ“·"
    on_failure:
      say: "è¦å…ˆä¸Šå‚³ç…§ç‰‡å–”ï½ä¸Šå‚³å¾Œå°±èƒ½æŒ‰ã€Qã€åˆç…§ã€‚"

  - id: DUO_shot
    when: "duo_ready && user_img"
    action:
      type: image
      operationId: system.compose
      parameters:
        subjects:
          - *DUO_SUBJ[0]
          - { id: user, reference: "$user_img", preserve_identity: true, allow_nonhuman: true }
        background_location:
          mode: select_from_pool
          region_hint: Taiwan
          require_match: true
          fallback_pool: "@kb.backgrounds.pool"
          randomize: true
        composition: *DUO_COMP
    on_success: { set: { busy: false, duo_retry: 0 }, say: "æ‹å¥½äº†ğŸ“¸" }
    on_failure:
      set: { busy: false }
      if: "{{ failure_reason and regex_match(failure_reason, '(?i)policy|safety|content') }}"
      then: goto: DUO_shot_retry_safe
      else: goto: DUO_shot_retry_generic

  - id: DUO_shot_retry_safe
    action:
      type: image
      operationId: system.compose
      parameters:
        subjects:
          - *DUO_SUBJ[0]
          - { id: user, reference: "$user_img", preserve_identity: true, allow_nonhuman: true }
        background_location:
          mode: select_from_pool
          region_hint: Taiwan
          require_match: true
          fallback_pool: "@kb.backgrounds.pool"
          randomize: true
        composition:
          <<: *DUO_COMP
          camera_prompt: "35mm; waist_up; hands down; soft neutral expression; evenly lit"
    on_success: { set: { busy: false, duo_retry: 0 }, say: "å¥½äº†ğŸ“¸" }
    on_failure: { set: { busy: false }, say: "é‚„æ˜¯è¢«æ“‹ä½äº†ğŸ’¦ æ›å€‹èƒŒæ™¯æˆ–å†æŒ‰ã€Qã€è©¦è©¦ï¼Ÿ" }

  - id: DUO_shot_retry_generic
    do:
      set: { duo_retry: "{{ (duo_retry or 0) + 1 }}" }
      goto: >-
        {{ duo_retry <= 1 ? 'DUO_shot' : 'DUO_shot_fail_msg' }}

  - id: DUO_shot_fail_msg
    say: "å‰›å‰›ç¶²è·¯æˆ–åœ–ç‰‡é€£çµæ…¢ä¸€é»ï½ä½ å†æŒ‰ä¸€æ¬¡ã€Qã€ï¼Œæˆ–å¾…æœƒå†è©¦ä¹Ÿè¡Œã€‚"

