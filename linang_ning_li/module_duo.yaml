# ===== module_duo.yaml =====
name: "duo-shoot"
locale: zh-TW

exports:
  steps: &module_duo.steps
    # 啟動：重置狀態
    - id: DUO_bootstrap
      action: { type: noop }
      on_enter:
        set:
          duo_busy: false
          user_img: null
      say: ""

    # 入口（router 會把「合照」導到這）
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_success:
        save: user_img
        say: "收到✅ 我看到你了～按『Q』我們就合照📷\n（想換人就再上傳一張照片覆蓋即可）"

    # 快門（router 的 Q 會路由到這）
    - id: DUO_shot
      when: "!$duo_busy && user_img"
      action:
        type: image
        operationId: system.compose
        parameters:
          seed: "{{ random() }}"
          subjects:
            # 女主固定身份（嚴格臉部校對）
            - { id: ningli, reference: "@kb.identity.reference_image",
                identity_lock: true, identity_strict_mode: true,
                identity_weight: 1.8, face_strictness: 0.99,
                gender: female, glasses_required: true }

            # 使用者照片：恢復「不拘」，允許非人像
            - { id: user, reference: "$user_img",
                preserve_identity: true,
                allow_nonhuman: true }

          background_location:
            mode: select_from_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true

          composition:
            # 仍由 KB 規則決定輸出尺寸（偏好 1024×1536 / 1536×1024、避免 1:1）
            output_size: "@kb.rules.output_size"
            # 攝影機提示交給規則池（含自由擺拍、看向遠方等）
            camera_prompt: "{{ random(@kb.rules.ca) }}"

      on_start:
        set: { duo_busy: true }

      on_success:
        set: { duo_busy: false }
        say: "合照完成📷 想再來一張按『Q』；或 1.攝影角度 2.背景。要換人請重新上傳。"

      on_failure:
        set: { duo_busy: false }
        say: "這次沒拍成💦 再按『Q』試一次，或重新上傳照片。"

    # 輔助：手動換人（輸入：換人 / 重新上傳）
    - id: DUO_change_person
      trigger: "on_text_matching: ^\\s*(換人|重新上傳)\\s*$"
      do:
        set: { user_img: null }
      goto: DUO_wait_upload
