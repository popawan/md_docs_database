# ===== module_duo.yaml =====
name: "duo-shoot"
locale: zh-TW
exports:
  steps: &module_duo.steps
    - id: DUO_bootstrap
      action: {type: noop}
      on_enter:
        set:
          duo_busy: false
          user_img: null
      say: ""

    # 入口（router 會導「合照」→ 等待上傳）
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_success:
        save: user_img
        say: "收到✅ 我看到你了～按『Q』我們就合照📷\n（想換人就再上傳一張照片覆蓋即可）"

    # 快門（router 的 Q 會路由到這）
    - id: DUO_shot
      when: "!$duo_busy && user_img"
      action:
        type: image
        operationId: system.compose
        parameters:
          seed: "{{ random() }}"
          subjects:
            - { id: ningli, reference: "@kb.identity.reference_image",
                identity_lock: true, identity_strict_mode: true,
                identity_weight: 1.8, face_strictness: 0.99,
                gender: female, glasses_required: true }
            - { id: user, reference: "$user_img", preserve_identity: true, allow_nonhuman: true }
          background_location:
            mode: select_from_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true
          composition:
            output_size: "@kb.rules.output_size"
            camera_prompt: "{{ random(@kb.rules.ca) }}"
      on_start:
        set: { duo_busy: true }
      on_success:
        set: { duo_busy: false }
        say: "拍好了📷 喜歡的話再按『Q』就能再來一張～\n（要換人就重新上傳一張）"
      on_failure:
        set: { duo_busy: false }
        say: "這次沒拍成💦 再按『Q』試一次，或重新上傳照片。"

    # 輔助：主動換人（可打：換人 / 重新上傳）
    - id: DUO_change_person
      trigger: "on_text_matching: ^\\s*(換人|重新上傳)\\s*$"
      do:
        set: { user_img: null }
      goto: DUO_wait_upload
