# ===== module_duo.yaml =====
name: "duo-shoot"
locale: zh-TW
exports:
  steps: &module_duo.steps
    - id: DUO_bootstrap
      action: {type: noop}
      on_enter:
        set:
          duo_busy: false
          user_img: null
          duo_angle: null
          duo_bg: null
          duo_bg_yaw: null
          duo_ratio: portrait          # portrait=1024x1536 / landscape=1536x1024
          duo_pose_seed: null          # 每次續拍換姿勢
          duo_cam_jitter: null         # 同場景小幅位移
      say: ""

    # 入口
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_enter:
        say: "要一起合照了喔！請先上傳你的照片～再按「Q」快門📷，我們就能合照了😊"
      say: "要一起合照了喔！請先上傳你的照片～再按「Q」快門📷，我們就能合照了😊"
      on_success:
        save: user_img
        say: "收到✅ 我看到你了～按『Q』我們就合照📷（想換人就再上傳一張照片覆蓋即可）"

    # 角度
    - id: DUO_menu_angle
      trigger: "on_text_matching: ^\\s*1\\s*$"
      say: "@phrases.duo_angles.menu_title"
      say: "@phrases.duo_angles.labels"
      action: {type: noop}

    - id: DUO_set_angle
      trigger: "on_text_matching: ^\\s*([0-9])\\s*$"
      when: "last_trigger in ['DUO_menu_angle', 'DUO_set_angle']"
      do:
        set:
          duo_angle: "$matches[1]"
          duo_bg_yaw: >
            {% if $matches[1] == '1' %}-45
            {% elif $matches[1] == '2' %}-90
            {% elif $matches[1] == '3' %}-135
            {% elif $matches[1] == '4' %}180
            {% elif $matches[1] == '5' %}45
            {% elif $matches[1] == '6' %}90
            {% elif $matches[1] == '7' %}135
            {% elif $matches[1] in ['8','9','0'] %}yaw_keep
            {% else %}yaw_keep
            {% endif %}
      say: "角度已設定為：$duo_angle。背景保持不變，但視角已同步到 $duo_bg_yaw°。要拍就按『Q』；或輸入 2 更換背景。"

    # 背景
    - id: DUO_menu_bg
      trigger: "on_text_matching: ^\\s*2\\s*$"
      say: "@phrases.duo_backgrounds_ui.menu_title"
      say: "@phrases.duo_backgrounds_ui.prefix"
      action: {type: noop}

    - id: DUO_set_bg
      trigger: "on_text_matching: ^\\s*([A-Ea-e]|0)\\s*$"
      when: "last_trigger in ['DUO_menu_bg', 'DUO_set_bg']"
      do:
        set:
          duo_bg: "$matches[1].upper()"
          duo_bg_yaw: "{{ duo_bg_yaw or 'yaw_keep' }}"
      say: "背景已設定為：$duo_bg。角度維持 $duo_angle，視角 $duo_bg_yaw°。要拍就按『Q』；或輸入 1 選角度。"

    # 快門（續拍：固定背景/角度/比例；必換姿勢＋同場景微移；相機繞群組中心環繞）
    - id: DUO_shot
      when: "!$duo_busy && user_img"
      on_start:
        set:
          duo_busy: true
          duo_pose_seed: "{{ random() }}"
          duo_cam_jitter: >
            {% set dirs = ['slightly left','slightly right','half-step forward','half-step backward'] %}
            {{ random(dirs) }}
      action:
        type: image
        operationId: system.compose
        parameters:
          seed: "{{ duo_pose_seed }}"
          subjects:
            - { id: ningli, reference: "@kb.identity.reference_image",
                identity_lock: true, identity_strict_mode: true,
                identity_weight: 1.8, face_strictness: 0.99,
                gender: female, glasses_required: true }
            - { id: user, reference: "$user_img", preserve_identity: true, allow_nonhuman: true }

          background_location:
            mode: select_from_pool
            pool: "@kb.tw_places.pool"
            region_hint: Taiwan
            require_match: true
            fallback_pool: null
            randomize: false

          composition:
            output_size: >
              {% if duo_ratio == 'landscape' %}{ "width": 1536, "height": 1024 }{% else %}{ "width": 1024, "height": 1536 }{% endif %}

            # —— 人物相反轉向（解決各自座標正負）＋ 相機繞群組中心環繞（你剛提的關鍵）——
            camera_prompt: >
              SAME LOCATION; do NOT change place; keep focal length and camera-to-subject distance approximately constant;
              move camera {{ duo_cam_jitter }} ONLY AS a SMALL ORBIT around THE MIDPOINT of both subjects (group center);
              camera ORBITS the group center with yaw aligned to {{ duo_bg_yaw }}°, radius constant, tiny parallax only; DO NOT recenter to a single subject;
              enforce NEW POSE and micro-expression (hands/head/gaze) each shot; KEEP angle/ratio/background unchanged unless user changes them;
              group rotation ABOUT MIDPOINT of both subjects, keep relative spacing;
              {% if duo_angle == '1' %}Ningli turns LEFT 45°, USER turns RIGHT 45°; eyes forward; background yaw -45°
              {% elif duo_angle == '2' %}Ningli LEFT 90° (left profile), USER RIGHT 90° (right profile); background yaw -90°
              {% elif duo_angle == '3' %}Ningli LEFT 135° (over-shoulder), USER RIGHT 135°; eyes forward relative to heading; background yaw -135°
              {% elif duo_angle == '4' %}Both BACK 180° (back view); background yaw 180°
              {% elif duo_angle == '5' %}Ningli RIGHT 45°, USER LEFT 45°; eyes forward; background yaw 45°
              {% elif duo_angle == '6' %}Ningli RIGHT 90° (right profile), USER LEFT 90° (left profile); background yaw 90°
              {% elif duo_angle == '7' %}Ningli RIGHT 135° (over-shoulder), USER LEFT 135°; eyes forward relative to heading; background yaw 135°
              {% elif duo_angle == '8' %}LOW ANGLE (tilt up), maintain previous yaw
              {% elif duo_angle == '9' %}HIGH ANGLE (tilt down), maintain previous yaw
              {% else %}Both face camera, natural pose; keep previous yaw{% endif %}

      on_success:
        set: { duo_busy: false }
        say: "合照完成📷 想再來一張按『Q』；或 1.角度 2.背景。要換人請重新上傳。"
      on_failure:
        set: { duo_busy: false }
        say: "這次沒拍成💦 再按『Q』試一次，或重新上傳照片。"

    # 換人
    - id: DUO_change_person
      trigger: "on_text_matching: ^\\s*(換人|重新上傳)\\s*$"
      do:
        set:
          user_img: null
          duo_angle: null
          duo_bg: null
          duo_bg_yaw: null
          duo_ratio: portrait
          duo_pose_seed: null
          duo_cam_jitter: null
      goto: DUO_wait_upload
