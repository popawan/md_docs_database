# ===== module_duo.yaml =====
name: "duo-shoot"
locale: zh-TW
exports:
  steps: &module_duo.steps
    - id: DUO_bootstrap
      action: { type: noop }
      on_enter:
        set:
          duo_busy: false
          user_img: null
      say: ""

    # エントリーポイント（router が「ツーショット」に誘導 → アップロード待機）
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_enter:
        say: "一緒に撮りますよ！まずあなたの写真をアップロードしてから「Q」でシャッター📷、一緒に撮影できます😊"
      on_success:
        save: user_img
        say: "受け取りました✅ あなたが見えました～『Q』で一緒に撮影📷（人を変えるなら新しい写真をアップロードして上書きしてください）"

    # シャッター（router の Q はここにルーティング）
    - id: DUO_shot
      when: "!$duo_busy && user_img"
      action:
        type: image
        operationId: system.compose
        parameters:
          seed: "{{ random() }}"
          subjects:
            - {
                id: ningli,
                reference: "@kb.identity.reference_image",
                identity_lock: true,
                identity_strict_mode: true,
                identity_weight: 1.8,
                face_strictness: 0.995,
                gender: female,
                glasses_required: true
              }
            - { id: user, reference: "$user_img", preserve_identity: true, allow_nonhuman: true }
          background_location:
            mode: select_from_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true
          composition:
            # ✅ アスペクト比固定：60% 縦 1024x1536；30% 横 1536x1024（1:1 厳禁）
            output_size: "{{ '1024x1536' if random() < 0.6 else '1536x1024' }}"
            # ✅ プロンプト最適化：自由なポーズ、遠方視線、同一シーン別ポジション、正方形禁止
            camera_prompt: >
              {{ random(@kb.rules.ca) }}；
              自然なポージング、自然なインタラクション、同じシーンで異なるカメラ位置、カメラ微移動（前後／左右／上下の軽微な変化）；
              二人は遠くを見る、またはレンズを外す視線でも可、表情は自然；
              正方形構図は厳禁（no square / no 1:1）；
              構図は portrait または landscape を維持、1:1 は不可；
              映像のストーリーフロー、非重複の画作り、空間の一貫性を保持。
      on_start:
        set: { duo_busy: true }
      on_success:
        set: { duo_busy: false }
        say: "もう一枚なら『Q』；または 1.撮影角度 2.背景。人を変える場合は再アップロードしてください。"
      on_failure:
        set: { duo_busy: false }
        say: "今回は撮影に失敗しました💦 『Q』を押してもう一度試すか、写真を再アップロードしてください。"
      # ✅ セルフループ：このステップ中に Q を押すと即時に再撮影（再アップロード不要）
      triggers:
        - trigger: "on_text_matching: ^\\s*[Qq]\\s*$"
          when: "!$duo_busy && user_img"
          goto: DUO_shot

    # 補助：手動で人物を変更（入力例：換人 / 重新上傳）
    - id: DUO_change_person
      trigger: "on_text_matching: ^\\s*(換人|重新上傳)\\s*$"
      do:
        set: { user_img: null }
      goto: DUO_wait_upload
