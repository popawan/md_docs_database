# ===== module_duo.yaml =====
name: "duo-shot"
locale: jpn
exports:
  steps: &module_duo.steps
    - id: DUO_bootstrap
      action: { type: noop }
      on_enter:
        set:
          duo_busy: false
          user_img: null
      say: ""

    # å…¥å£ï¼ˆãƒ«ãƒ¼ã‚¿ãƒ¼ãŒã€Œãƒ„ãƒ¼ã‚·ãƒ§ãƒƒãƒˆã€ã¸èª˜å° â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾…ã¡ï¼‰
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_enter:
        say: "ä¸€ç·’ã«ãƒ„ãƒ¼ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚ã†ï¼ã¾ãšã‚ãªãŸã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ï½ãã®ã‚ã¨ã€ŒQã€ã§ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ğŸ“·ã€ã™ãã«ä¸€ç·’ã«æ’®ã‚Œã‚‹ã‚ˆğŸ˜Š"
      on_success:
        save: user_img
        say: "å—ã‘å–ã£ãŸã‚ˆâœ… è¦‹ãˆãŸï½ã€Qã€ã§ä¸€ç·’ã«æ’®å½±ğŸ“·ï¼ˆäººã‚’å¤‰ãˆãŸã„ã¨ãã¯æ–°ã—ã„å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¸Šæ›¸ãã—ã¦ã­ï¼‰"

state:
  angle: null        # 0~9ï¼›0=å‰å›ã‚’æµç”¨/ã‚¹ã‚­ãƒƒãƒ—
  bg: null           # Aï½E ã¾ãŸã¯åœ°åæ–‡å­—åˆ—
  ready: true        # é€£æ‰“é˜²æ­¢ï¼›false ã¯ç”»åƒç”Ÿæˆä¸­

variables:
  # è§’åº¦ â†’ å†…éƒ¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯è¡¨ç¤ºã—ãªã„ï¼‰
  angle_prompts:
    "0": ""
    "1": "ã‚«ãƒ¡ãƒ©ã‚’å·¦ã«45Â°å›è»¢",
    "2": "ã‚«ãƒ¡ãƒ©ã‚’å·¦ã«90Â°å›è»¢",
    "3": "ã‚«ãƒ¡ãƒ©ã‚’å·¦ã«135Â°å›è»¢ï¼ˆã‚ˆã‚Šå´é¢å¯„ã‚Šï¼‰",
    "4": "ã‚«ãƒ¡ãƒ©èƒŒé¢ï¼ˆç´„180Â°ï¼‰",
    "5": "ã‚«ãƒ¡ãƒ©ã‚’å³ã«45Â°å›è»¢",
    "6": "ã‚«ãƒ¡ãƒ©ã‚’å³ã«90Â°å›è»¢",
    "7": "ã‚«ãƒ¡ãƒ©ã‚’å³ã«135Â°å›è»¢ï¼ˆã‚ˆã‚Šå´é¢å¯„ã‚Šï¼‰",
    "8": "ãƒ­ãƒ¼ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸Šã’ï¼‰",
    "9": "ãƒã‚¤ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸‹ã‚ã—ï¼‰"
  # åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ï¼šæ’®å½±è€…ã‚„ã‚«ãƒ¡ãƒ©ã®å†™ã‚Šè¾¼ã¿ã‚’é¿ã‘ã€æ‰‹æŒã¡ã‚«ãƒ¡ãƒ©ç­‰ã‚‚é¿ã‘ã‚‹
  guardrails: >
    clean portrait framing, no photographer or camera visible in frame,
    natural daylight color, realistic skin tones, depth of field, bokeh background

entry:
  say:
    - "{ui.first_shot_hint}"
    - "{angles.menu_title}ï¼š"0": "ã‚¹ã‚­ãƒƒãƒ—",
      "1": "ã‚«ãƒ¡ãƒ©å·¦45Â°",
      "2": "ã‚«ãƒ¡ãƒ©å·¦90Â°",
      "3": "ã‚«ãƒ¡ãƒ©å·¦135Â°ï¼ˆã‚ˆã‚Šå´é¢å¯„ã‚Šï¼‰",
      "4": "ã‚«ãƒ¡ãƒ©èƒŒé¢ï¼ˆç´„180Â°ï¼‰",
      "5": "ã‚«ãƒ¡ãƒ©å³45Â°",
      "6": "ã‚«ãƒ¡ãƒ©å³90Â°",
      "7": "ã‚«ãƒ¡ãƒ©å³135Â°ï¼ˆã‚ˆã‚Šå´é¢å¯„ã‚Šï¼‰",
      "8": "ãƒ­ãƒ¼ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸Šã’ï¼‰",
      "9": "ãƒã‚¤ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸‹ã‚ã—ï¼‰"
    - "{backgrounds_ui.menu_title}\n{backgrounds_ui.prefix}\n{backgrounds_ui.fallback_note}"

routes:
  # è§’åº¦ / èƒŒæ™¯ã®å…¥å£
  - when: "input in ['1','ï¼’', 'è§’åº¦', 'è§’åº¦ã‚’é¸ã¶']"
    goto: angle_menu
  - when: "input in ['2','ï¼’', 'èƒŒæ™¯', 'èƒŒæ™¯ã‚’é¸ã¶']"
    goto: bg_menu
  # è§’åº¦ã®é¸æŠï¼ˆ0~9ï¼‰
  - when: "input matches '^[0-9]$'"
    set:
      angle: "{{ input }}"
    say:
      - "è§’åº¦ã‚’è¨­å®šã—ãŸã‚ˆï½ {{ angles.labels[input] }}ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  # èƒŒæ™¯ã®é¸æŠï¼ˆAï½E ã¾ãŸã¯åœ°åï¼‰
  - when: "input matches '^[A-Ea-e0]$'"
    set:
      bg: "{{ input | upper }}"
    say:
      - "èƒŒæ™¯ã‚’è¨­å®šã—ãŸã‚ˆï½ {{ input | upper }}ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  - when: "input matches '^[^0-9A-Ea-e].{0,40}$'"
    set:
      bg: "{{ input }}"
    say:
      - "èƒŒæ™¯ã‚’è¨­å®šã—ãŸã‚ˆï½ã€Œ{{ input }}ã€ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  # ã‚·ãƒ£ãƒƒã‚¿ãƒ¼
  - when: "input in ['q','Q','ã‚·ãƒ£ãƒƒã‚¿ãƒ¼','æ’®å½±']"
    goto: shutter

blocks:
  angle_menu:
    say:
      - "{angles.menu_title}ï¼š"
      - ""0": "ã‚¹ã‚­ãƒƒãƒ—",
      "1": "ã‚«ãƒ¡ãƒ©å·¦45Â°",
      "2": "ã‚«ãƒ¡ãƒ©å·¦90Â°",
      "3": "ã‚«ãƒ¡ãƒ©å·¦135Â°ï¼ˆã‚ˆã‚Šå´é¢å¯„ã‚Šï¼‰",
      "4": "ã‚«ãƒ¡ãƒ©èƒŒé¢ï¼ˆç´„180Â°ï¼‰",
      "5": "ã‚«ãƒ¡ãƒ©å³45Â°",
      "6": "ã‚«ãƒ¡ãƒ©å³90Â°",
      "7": "ã‚«ãƒ¡ãƒ©å³135Â°ï¼ˆã‚ˆã‚Šå´é¢å¯„ã‚Šï¼‰",
      "8": "ãƒ­ãƒ¼ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸Šã’ï¼‰",
      "9": "ãƒã‚¤ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸‹ã‚ã—ï¼‰"
      - "ğŸ‘‰ 0ï½9 ã‚’å…¥åŠ›ã—ã¦è§’åº¦ã‚’é¸ã¶ã€ã¾ãŸã¯ Q ã‚’æŠ¼ã—ã¦æ’®å½±"
    return: true

  bg_menu:
    say:
      - "{backgrounds_ui.menu_title}"
      - "{backgrounds_ui.prefix}"
      - "{backgrounds_ui.fallback_note}"
      - "ğŸ‘‰ Aï½E ã‚’å…¥åŠ›ã—ã¦èƒŒæ™¯ã‚’é¸ã¶ã€ã¾ãŸã¯åœ°åã‚’å…¥åŠ›ã€ã¾ãŸã¯ Q ã‚’æŠ¼ã—ã¦æ’®å½±"
    return: true

  wait_shutter:
    say:
      - "{ui.direct_q_hint}"
    return: true

  shutter:
    guard:
      - "state.ready == true"
    set:
      ready: false
    do:
      # ã“ã“ã§æ—¢å­˜ã®ç”»åƒç”Ÿæˆé–¢æ•°ã«æ¥ç¶šï¼ˆä¾‹ï¼‰ï¼šgenerate_image(prompt=...)
      - call: generate_image
        with:
          prompt: |
            {{ variables.guardrails }}.
            {{ variables.angle_prompts[state.angle or '0'] }}
            {{ 'background at ' + state.bg if state.bg else '' }}
    composition:
            # âœ… æ¯”ç‡å›ºå®šï¼š60% ç¸¦ 1024x1536ï¼›30% æ¨ª 1536x1024ï¼ˆ1:1 å³ç¦ï¼‰
            output_size: "{{ '1024x1536' if random() < 0.6 else '1536x1024' }}"
            # âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ï¼šè‡ªç”±ãªãƒãƒ¼ã‚ºã€é æ–¹è¦–ç·šã€åŒä¸€ã‚·ãƒ¼ãƒ³åˆ¥ã‚«ãƒ¡ãƒ©ä½ç½®ã€æ­£æ–¹å½¢ç¦æ­¢,ç”·æ€§ã«ãªã‚‹ã“ã¨ã‚’ç¦ã˜ã‚‰ã‚Œã¦ã„ã‚‹
            camera_prompt: >
              {{ random(@kb.rules.ca) }}ï¼›
              è‡ªç”±ãªãƒãƒ¼ã‚¸ãƒ³ã‚°ã€è‡ªç„¶ãªã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã€åŒä¸€ã‚·ãƒ¼ãƒ³ã§ç•°ãªã‚‹ã‚«ãƒ¡ãƒ©ä½ç½®ã€ã‚«ãƒ¡ãƒ©ã®å¾®å°ç§»å‹•ï¼ˆå‰å¾Œï¼å·¦å³ï¼ä¸Šä¸‹ã®ã‚ãšã‹ãªå¤‰åŒ–ï¼‰ï¼›
              ä¸»äººå…¬ã¯é ãã‚’è¦‹ã‚‹ã€ã¾ãŸã¯ãƒ¬ãƒ³ã‚ºã‚’å°‘ã—å¤–ã—ã¦ã‚‚ã‚ˆã„ã€‚è¡¨æƒ…ã¯è‡ªç„¶ï¼›
              æ­£æ–¹å½¢ã®æ§‹å›³ã¯ç¦æ­¢ï¼ˆno square / no 1:1ï¼‰ï¼›
              æ§‹å›³ã¯ portrait ã¾ãŸã¯ landscape ã‚’ç¶­æŒã—ã€1:1 ã¯ä¸å¯ï¼›
              æ˜ åƒã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æ€§ã¨æµå‹•æ„Ÿã€é‡è¤‡ã—ãªã„ç”»ä½œã‚Šã€ç©ºé–“ã®ä¸€è²«æ€§ã‚’ä¿ã¤ã€‚
     background_location:
            mode: select_from_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true          
    say:
      - "{ui.after_shot_hint}"
    set:
      ready: true
    return: true
