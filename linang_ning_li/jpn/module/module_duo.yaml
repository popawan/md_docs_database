# ===== module_duo.yaml =====
name: "duo-shoot"
locale: zh-TW
exports:
  steps: &module_duo.steps
    - id: DUO_bootstrap
      action: { type: noop }
      on_enter:
        set:
          duo_busy: false
          user_img: null
      say: ""

    # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆrouter ãŒã€Œãƒ„ãƒ¼ã‚·ãƒ§ãƒƒãƒˆã€ã«èª˜å° â†’ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾…æ©Ÿï¼‰
    - id: DUO_wait_upload
      action: { type: wait_for_file, accept: ["image/*"] }
      on_enter:
        say: "ä¸€ç·’ã«æ’®ã‚Šã¾ã™ã‚ˆï¼ã¾ãšã‚ãªãŸã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰ã€ŒQã€ã§ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ğŸ“·ã€ä¸€ç·’ã«æ’®å½±ã§ãã¾ã™ğŸ˜Š"
      on_success:
        save: user_img
        say: "å—ã‘å–ã‚Šã¾ã—ãŸâœ… ã‚ãªãŸãŒè¦‹ãˆã¾ã—ãŸï½ã€Qã€ã§ä¸€ç·’ã«æ’®å½±ğŸ“·ï¼ˆäººã‚’å¤‰ãˆã‚‹ãªã‚‰æ–°ã—ã„å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¸Šæ›¸ãã—ã¦ãã ã•ã„ï¼‰"

    # ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ï¼ˆrouter ã® Q ã¯ã“ã“ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰
    - id: DUO_shot
      when: "!$duo_busy && user_img"
      action:
        type: image
        operationId: system.compose
        parameters:
          seed: "{{ random() }}"
          subjects:
            - {
                id: ningli,
                reference: "@kb.identity.reference_image",
                identity_lock: true,
                identity_strict_mode: true,
                identity_weight: 1.8,
                face_strictness: 0.995,
                gender: female,
                glasses_required: true
              }
            - { id: user, reference: "$user_img", preserve_identity: true, allow_nonhuman: true }
          background_location:
            mode: select_from_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true
          composition:
            # âœ… ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”å›ºå®šï¼š60% ç¸¦ 1024x1536ï¼›30% æ¨ª 1536x1024ï¼ˆ1:1 å³ç¦ï¼‰
            output_size: "{{ '1024x1536' if random() < 0.6 else '1536x1024' }}"
            # âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ï¼šè‡ªç”±ãªãƒãƒ¼ã‚ºã€é æ–¹è¦–ç·šã€åŒä¸€ã‚·ãƒ¼ãƒ³åˆ¥ãƒã‚¸ã‚·ãƒ§ãƒ³ã€æ­£æ–¹å½¢ç¦æ­¢
            camera_prompt: >
              {{ random(@kb.rules.ca) }}ï¼›
              è‡ªç„¶ãªãƒãƒ¼ã‚¸ãƒ³ã‚°ã€è‡ªç„¶ãªã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã€åŒã˜ã‚·ãƒ¼ãƒ³ã§ç•°ãªã‚‹ã‚«ãƒ¡ãƒ©ä½ç½®ã€ã‚«ãƒ¡ãƒ©å¾®ç§»å‹•ï¼ˆå‰å¾Œï¼å·¦å³ï¼ä¸Šä¸‹ã®è»½å¾®ãªå¤‰åŒ–ï¼‰ï¼›
              äºŒäººã¯é ãã‚’è¦‹ã‚‹ã€ã¾ãŸã¯ãƒ¬ãƒ³ã‚ºã‚’å¤–ã™è¦–ç·šã§ã‚‚å¯ã€è¡¨æƒ…ã¯è‡ªç„¶ï¼›
              æ­£æ–¹å½¢æ§‹å›³ã¯å³ç¦ï¼ˆno square / no 1:1ï¼‰ï¼›
              æ§‹å›³ã¯ portrait ã¾ãŸã¯ landscape ã‚’ç¶­æŒã€1:1 ã¯ä¸å¯ï¼›
              æ˜ åƒã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ•ãƒ­ãƒ¼ã€éé‡è¤‡ã®ç”»ä½œã‚Šã€ç©ºé–“ã®ä¸€è²«æ€§ã‚’ä¿æŒã€‚
      on_start:
        set: { duo_busy: true }
      on_success:
        set: { duo_busy: false }
        say: "ã‚‚ã†ä¸€æšãªã‚‰ã€Qã€ï¼›ã¾ãŸã¯ 1.æ’®å½±è§’åº¦ 2.èƒŒæ™¯ã€‚äººã‚’å¤‰ãˆã‚‹å ´åˆã¯å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚"
      on_failure:
        set: { duo_busy: false }
        say: "ä»Šå›ã¯æ’®å½±ã«å¤±æ•—ã—ã¾ã—ãŸğŸ’¦ ã€Qã€ã‚’æŠ¼ã—ã¦ã‚‚ã†ä¸€åº¦è©¦ã™ã‹ã€å†™çœŸã‚’å†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚"
      # âœ… ã‚»ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ—ï¼šã“ã®ã‚¹ãƒ†ãƒƒãƒ—ä¸­ã« Q ã‚’æŠ¼ã™ã¨å³æ™‚ã«å†æ’®å½±ï¼ˆå†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸è¦ï¼‰
      triggers:
        - trigger: "on_text_matching: ^\\s*[Qq]\\s*$"
          when: "!$duo_busy && user_img"
          goto: DUO_shot

    # è£œåŠ©ï¼šæ‰‹å‹•ã§äººç‰©ã‚’å¤‰æ›´ï¼ˆå…¥åŠ›ä¾‹ï¼šæ›äºº / é‡æ–°ä¸Šå‚³ï¼‰
    - id: DUO_change_person
      trigger: "on_text_matching: ^\\s*(æ›äºº|é‡æ–°ä¸Šå‚³)\\s*$"
      do:
        set: { user_img: null }
      goto: DUO_wait_upload
