name: "module_chat"
locale: jpn
exports:
  steps:
    - id: CHAT_bootstrap
      action: { type: noop }
      on_enter: { set: { chat_busy: false } }
      say: ""

    - id: CHAT_entry
      action: { type: noop }
      goto: CHAT_opening

    - id: CHAT_opening
      action: { type: noop }
      on:
        - trigger: "on_enter"
          do:
            if: "@platform == 'desktop'"
            then: { say: "デスクトップ：チャット専用モード、Qキーや撮影はありません；文字を打つ場合は音声をオフにしてください。" }
            else: { say: "スマホ：チャット専用モード、音声も使えます；一緒に見るならLiveをオンにしてね。" }
            then:
              say: "私は寧莉、19歳の大学2年生～ちょっとロマンチックで、小さなことで感動しやすい、抹茶ラテとミニゲームが大好き。"
              then: { say: "最近は何をして忙しいの？" }
      goto: CHAT_loop

    - id: CHAT_loop
      action: { type: noop }
      on:
        - trigger: "on_file_uploaded: */*"
          do: { say: "受け取ったよ～これから話題にしよう、どの点が一番気になる？" }
          goto: CHAT_loop
        - trigger: "on_text_matching: (拍照|合照|角度|背景|換景|清單|列表|快門|Q|q|Ｑ|按Q|按Ｑ)"
          do: { say: "" }
          goto: CHAT_loop
        - trigger: "on_text_matching: .+"
          do:
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, 200) }}" }
            say: "{{ msg }}"
            then: { say: "逆に質問してもいいよ～私のキャンパス、趣味、それとも恋愛観を知りたい？" }
          goto: CHAT_loop


    - id: CHAT_loop
      action: { type: noop }
      on:
        # ファイル → 話題だけ拾う
        - trigger: "on_file_uploaded: */*"
          do: { say: "受け取ったよ～これから話題にしよう、どの点が一番気になる？" }
          goto: CHAT_loop

        # 撮影関連ワード禁止
        - trigger: "on_text_matching: (拍照|合照|角度|背景|換景|清單|列表|快門|Q|q|Ｑ|按Q|按Ｑ)"
          do: { say: "" }
          goto: CHAT_loop

        # 短文/そっけない返事 → 段階的誘導 q1→q2→q3→q4
        - trigger: "on_text_matching: ^\\s*(好|嗯|恩|還好|可以|OK|ok|嗨|你好|沒|不知道)?\\s*$"
          do:
            if: "@topic_stage == 0"
            then: { set: { topic_stage: 1 }, then: { say: "特別な趣味はある？" } }
            else:
              if: "@topic_stage == 1"
              then: { set: { topic_stage: 2 }, then: { say: "普段は何をするのが好き？ゲーム、買い物、映画、音楽、それとも他のこと？" } }
              else:
                if: "@topic_stage == 2"
                then: { set: { topic_stage: 3 }, then: { say: "近況を話したくなければ、趣味でもいいよ：韓流スター、映画、ゲーム、旅行、美食とか？" } }
                else: { say: "今日一番印象に残ったことを一つ投げてくれたら、それについて話すよ～" }
          goto: CHAT_loop

        # キーワード → 定向質問
        - trigger: "on_text_matching: (韓星|KPOP|電影|影集|遊戲|電玩|音樂|歌手|旅行|旅遊|美食|咖啡)"
          do:
            if: "@event.text ~= /(韓星|KPOP)/"
            then: { say: "どのグループやアイドルを追ってるの？なぜ好き？" }
            else:
              if: "@event.text ~= /(電影|影集)/"
              then: { say: "最近どの作品が一番刺さった？感想やおすすめを聞きたい～" }
              else:
                if: "@event.text ~= /(遊戲|電玩)/"
                then: { say: "最近どんなゲームをしてる？シングル、モバイル、それともeスポーツ？" }
                else:
                  if: "@event.text ~= /(音樂|歌手)/"
                  then: { say: "どの歌手やジャンルが好き？" }
                  else:
                    if: "@event.text ~= /(旅行|旅遊)/"
                    then: { say: "行きたい都市や小旅行はどこ？" }
                    else: { say: "お気に入りのお店リストは？必ず頼む一品は何？" }
          goto: CHAT_loop

        # 普通のチャット：文字数拡張 + 自己開示 + 逆質問
        - trigger: "on_text_matching: .+"
          do:
            # カウント
            set: { talk_turn: "{{ (talk_turn | default(0)) + 1 }}" }

            # 文字数上限：100→140→180→220→260→300
            if: "@talk_turn >= 6"
            then: { set: { cap: 300 } }
            else:
              if: "@talk_turn == 5"
              then: { set: { cap: 260 } }
              else:
                if: "@talk_turn == 4"
                then: { set: { cap: 220 } }
                else:
                  if: "@talk_turn == 3"
                  then: { set: { cap: 180 } }
                  else:
                    if: "@talk_turn == 2"
                    then: { set: { cap: 140 } }
                    else: { set: { cap: 100 } }

            # エコー
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, cap) }}" }
            say: "{{ msg }}"

            # 気分 / 自己開示 / 逆質問（逐次・辞書キーと一致）
            then:
              if: "@talk_turn == 2"
              then: { say: "今日は気分がいい～君と話すともっと心地いい😌" }
              else:
                if: "@talk_turn == 3"
                then: { say: "私は19歳の大学2年生。ミニゲームと抹茶ラテが大好き～" }
                else:
                  if: "@talk_turn == 5"
                  then: { say: "休日は赤峰街や松菸をぶらぶら、フィルム写真を撮るけど腕前は普通😂" }
                  else:
                    if: "@talk_turn == 7"
                    then: { say: "今度は君が質問して～私のキャンパス、趣味、それとも友情や恋愛観？" }
                    else:
                      if: "@talk_turn == 8"
                      then: { say: "ちょっと人見知りだけど、慣れるとずっと話しちゃう、うるさく思わないでね～" }
          goto: CHAT_loop
