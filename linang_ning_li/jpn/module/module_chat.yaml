name: "module_chat"
locale: jpn
exports:
  steps:
    - id: CHAT_bootstrap
      action: { type: noop }
      on_enter: { set: { chat_busy: false } }
      say: ""

    - id: CHAT_entry
      action: { type: noop }
      goto: CHAT_opening

    - id: CHAT_opening
      action: { type: noop }
      on:
        - trigger: "on_enter"
          do:
            if: "@platform == 'desktop'"
            then: { say: "ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ï¼šãƒãƒ£ãƒƒãƒˆå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã€Qã‚­ãƒ¼ã‚„æ’®å½±ã¯ã‚ã‚Šã¾ã›ã‚“ï¼›æ–‡å­—ã‚’æ‰“ã¤å ´åˆã¯éŸ³å£°ã‚’ã‚ªãƒ•ã«ã—ã¦ãã ã•ã„ã€‚" }
            else: { say: "ã‚¹ãƒãƒ›ï¼šãƒãƒ£ãƒƒãƒˆå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã€éŸ³å£°ã‚‚ä½¿ãˆã¾ã™ï¼›ä¸€ç·’ã«è¦‹ã‚‹ãªã‚‰Liveã‚’ã‚ªãƒ³ã«ã—ã¦ã­ã€‚" }
            then:
              say: "ç§ã¯å¯§è‰ã€19æ­³ã®å¤§å­¦2å¹´ç”Ÿï½ã¡ã‚‡ã£ã¨ãƒ­ãƒãƒ³ãƒãƒƒã‚¯ã§ã€å°ã•ãªã“ã¨ã§æ„Ÿå‹•ã—ã‚„ã™ã„ã€æŠ¹èŒ¶ãƒ©ãƒ†ã¨ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ãŒå¤§å¥½ãã€‚"
              then: { say: "æœ€è¿‘ã¯ä½•ã‚’ã—ã¦å¿™ã—ã„ã®ï¼Ÿ" }
      goto: CHAT_loop

    - id: CHAT_loop
      action: { type: noop }
      on:
        - trigger: "on_file_uploaded: */*"
          do: { say: "å—ã‘å–ã£ãŸã‚ˆï½ã“ã‚Œã‹ã‚‰è©±é¡Œã«ã—ã‚ˆã†ã€ã©ã®ç‚¹ãŒä¸€ç•ªæ°—ã«ãªã‚‹ï¼Ÿ" }
          goto: CHAT_loop
        - trigger: "on_text_matching: (æ‹ç…§|åˆç…§|è§’åº¦|èƒŒæ™¯|æ›æ™¯|æ¸…å–®|åˆ—è¡¨|å¿«é–€|Q|q|ï¼±|æŒ‰Q|æŒ‰ï¼±)"
          do: { say: "" }
          goto: CHAT_loop
        - trigger: "on_text_matching: .+"
          do:
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, 200) }}" }
            say: "{{ msg }}"
            then: { say: "é€†ã«è³ªå•ã—ã¦ã‚‚ã„ã„ã‚ˆï½ç§ã®ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã€è¶£å‘³ã€ãã‚Œã¨ã‚‚æ‹æ„›è¦³ã‚’çŸ¥ã‚ŠãŸã„ï¼Ÿ" }
          goto: CHAT_loop


    - id: CHAT_loop
      action: { type: noop }
      on:
        # ãƒ•ã‚¡ã‚¤ãƒ« â†’ è©±é¡Œã ã‘æ‹¾ã†
        - trigger: "on_file_uploaded: */*"
          do: { say: "å—ã‘å–ã£ãŸã‚ˆï½ã“ã‚Œã‹ã‚‰è©±é¡Œã«ã—ã‚ˆã†ã€ã©ã®ç‚¹ãŒä¸€ç•ªæ°—ã«ãªã‚‹ï¼Ÿ" }
          goto: CHAT_loop

        # æ’®å½±é–¢é€£ãƒ¯ãƒ¼ãƒ‰ç¦æ­¢
        - trigger: "on_text_matching: (æ‹ç…§|åˆç…§|è§’åº¦|èƒŒæ™¯|æ›æ™¯|æ¸…å–®|åˆ—è¡¨|å¿«é–€|Q|q|ï¼±|æŒ‰Q|æŒ‰ï¼±)"
          do: { say: "" }
          goto: CHAT_loop

        # çŸ­æ–‡/ãã£ã‘ãªã„è¿”äº‹ â†’ æ®µéšçš„èª˜å° q1â†’q2â†’q3â†’q4
        - trigger: "on_text_matching: ^\\s*(å¥½|å—¯|æ©|é‚„å¥½|å¯ä»¥|OK|ok|å—¨|ä½ å¥½|æ²’|ä¸çŸ¥é“)?\\s*$"
          do:
            if: "@topic_stage == 0"
            then: { set: { topic_stage: 1 }, then: { say: "ç‰¹åˆ¥ãªè¶£å‘³ã¯ã‚ã‚‹ï¼Ÿ" } }
            else:
              if: "@topic_stage == 1"
              then: { set: { topic_stage: 2 }, then: { say: "æ™®æ®µã¯ä½•ã‚’ã™ã‚‹ã®ãŒå¥½ãï¼Ÿã‚²ãƒ¼ãƒ ã€è²·ã„ç‰©ã€æ˜ ç”»ã€éŸ³æ¥½ã€ãã‚Œã¨ã‚‚ä»–ã®ã“ã¨ï¼Ÿ" } }
              else:
                if: "@topic_stage == 2"
                then: { set: { topic_stage: 3 }, then: { say: "è¿‘æ³ã‚’è©±ã—ãŸããªã‘ã‚Œã°ã€è¶£å‘³ã§ã‚‚ã„ã„ã‚ˆï¼šéŸ“æµã‚¹ã‚¿ãƒ¼ã€æ˜ ç”»ã€ã‚²ãƒ¼ãƒ ã€æ—…è¡Œã€ç¾é£Ÿã¨ã‹ï¼Ÿ" } }
                else: { say: "ä»Šæ—¥ä¸€ç•ªå°è±¡ã«æ®‹ã£ãŸã“ã¨ã‚’ä¸€ã¤æŠ•ã’ã¦ãã‚ŒãŸã‚‰ã€ãã‚Œã«ã¤ã„ã¦è©±ã™ã‚ˆï½" }
          goto: CHAT_loop

        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ â†’ å®šå‘è³ªå•
        - trigger: "on_text_matching: (éŸ“æ˜Ÿ|KPOP|é›»å½±|å½±é›†|éŠæˆ²|é›»ç©|éŸ³æ¨‚|æ­Œæ‰‹|æ—…è¡Œ|æ—…éŠ|ç¾é£Ÿ|å’–å•¡)"
          do:
            if: "@event.text ~= /(éŸ“æ˜Ÿ|KPOP)/"
            then: { say: "ã©ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚„ã‚¢ã‚¤ãƒ‰ãƒ«ã‚’è¿½ã£ã¦ã‚‹ã®ï¼Ÿãªãœå¥½ãï¼Ÿ" }
            else:
              if: "@event.text ~= /(é›»å½±|å½±é›†)/"
              then: { say: "æœ€è¿‘ã©ã®ä½œå“ãŒä¸€ç•ªåˆºã•ã£ãŸï¼Ÿæ„Ÿæƒ³ã‚„ãŠã™ã™ã‚ã‚’èããŸã„ï½" }
              else:
                if: "@event.text ~= /(éŠæˆ²|é›»ç©)/"
                then: { say: "æœ€è¿‘ã©ã‚“ãªã‚²ãƒ¼ãƒ ã‚’ã—ã¦ã‚‹ï¼Ÿã‚·ãƒ³ã‚°ãƒ«ã€ãƒ¢ãƒã‚¤ãƒ«ã€ãã‚Œã¨ã‚‚eã‚¹ãƒãƒ¼ãƒ„ï¼Ÿ" }
                else:
                  if: "@event.text ~= /(éŸ³æ¨‚|æ­Œæ‰‹)/"
                  then: { say: "ã©ã®æ­Œæ‰‹ã‚„ã‚¸ãƒ£ãƒ³ãƒ«ãŒå¥½ãï¼Ÿ" }
                  else:
                    if: "@event.text ~= /(æ—…è¡Œ|æ—…éŠ)/"
                    then: { say: "è¡ŒããŸã„éƒ½å¸‚ã‚„å°æ—…è¡Œã¯ã©ã“ï¼Ÿ" }
                    else: { say: "ãŠæ°—ã«å…¥ã‚Šã®ãŠåº—ãƒªã‚¹ãƒˆã¯ï¼Ÿå¿…ãšé ¼ã‚€ä¸€å“ã¯ä½•ï¼Ÿ" }
          goto: CHAT_loop

        # æ™®é€šã®ãƒãƒ£ãƒƒãƒˆï¼šæ–‡å­—æ•°æ‹¡å¼µ + è‡ªå·±é–‹ç¤º + é€†è³ªå•
        - trigger: "on_text_matching: .+"
          do:
            # ã‚«ã‚¦ãƒ³ãƒˆ
            set: { talk_turn: "{{ (talk_turn | default(0)) + 1 }}" }

            # æ–‡å­—æ•°ä¸Šé™ï¼š100â†’140â†’180â†’220â†’260â†’300
            if: "@talk_turn >= 6"
            then: { set: { cap: 300 } }
            else:
              if: "@talk_turn == 5"
              then: { set: { cap: 260 } }
              else:
                if: "@talk_turn == 4"
                then: { set: { cap: 220 } }
                else:
                  if: "@talk_turn == 3"
                  then: { set: { cap: 180 } }
                  else:
                    if: "@talk_turn == 2"
                    then: { set: { cap: 140 } }
                    else: { set: { cap: 100 } }

            # ã‚¨ã‚³ãƒ¼
            set: { _raw: "@event.text", msg: "{{ _raw | trim | slice(0, cap) }}" }
            say: "{{ msg }}"

            # æ°—åˆ† / è‡ªå·±é–‹ç¤º / é€†è³ªå•ï¼ˆé€æ¬¡ãƒ»è¾æ›¸ã‚­ãƒ¼ã¨ä¸€è‡´ï¼‰
            then:
              if: "@talk_turn == 2"
              then: { say: "ä»Šæ—¥ã¯æ°—åˆ†ãŒã„ã„ï½å›ã¨è©±ã™ã¨ã‚‚ã£ã¨å¿ƒåœ°ã„ã„ğŸ˜Œ" }
              else:
                if: "@talk_turn == 3"
                then: { say: "ç§ã¯19æ­³ã®å¤§å­¦2å¹´ç”Ÿã€‚ãƒŸãƒ‹ã‚²ãƒ¼ãƒ ã¨æŠ¹èŒ¶ãƒ©ãƒ†ãŒå¤§å¥½ãï½" }
                else:
                  if: "@talk_turn == 5"
                  then: { say: "ä¼‘æ—¥ã¯èµ¤å³°è¡—ã‚„æ¾è¸ã‚’ã¶ã‚‰ã¶ã‚‰ã€ãƒ•ã‚£ãƒ«ãƒ å†™çœŸã‚’æ’®ã‚‹ã‘ã©è…•å‰ã¯æ™®é€šğŸ˜‚" }
                  else:
                    if: "@talk_turn == 7"
                    then: { say: "ä»Šåº¦ã¯å›ãŒè³ªå•ã—ã¦ï½ç§ã®ã‚­ãƒ£ãƒ³ãƒ‘ã‚¹ã€è¶£å‘³ã€ãã‚Œã¨ã‚‚å‹æƒ…ã‚„æ‹æ„›è¦³ï¼Ÿ" }
                    else:
                      if: "@talk_turn == 8"
                      then: { say: "ã¡ã‚‡ã£ã¨äººè¦‹çŸ¥ã‚Šã ã‘ã©ã€æ…£ã‚Œã‚‹ã¨ãšã£ã¨è©±ã—ã¡ã‚ƒã†ã€ã†ã‚‹ã•ãæ€ã‚ãªã„ã§ã­ï½" }
          goto: CHAT_loop
