# === FACE LOCK (Photo) v11.1.1d ===
steps:
  - id: FACE_lock_bootstrap_PRO
    action: { type: noop }
    on_enter:
      set:
        # é¡”å›ºå®šï¼šå¤–éƒ¨ã§æŒ‡å®šãŒãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¾æ›¸ã‚’ä½¿ç”¨
        face_seed: "{{ face_seed | default(43199017) }}"
        face_style: "{{ face_style | default('ningli.v1') }}"
        face_lock: true          # ä¸‹æµã§ã®ãƒã‚§ãƒƒã‚¯ç”¨ã€ä¸Šæ›¸ãä¸å¯
    say: ""
    goto: ENTRY                 # æ—¢å­˜ã‚¨ãƒ³ãƒˆãƒªã‚’ç¶­æŒ


name: module_pro
type: module
version: 1

description: |
  ãƒ’ãƒ­ã‚¤ãƒ³å˜ç‹¬æ’®å½±ï¼ˆç›´ç·šãƒ•ãƒ­ãƒ¼ï¼‰ã€‚
  ç›®çš„ï¼šå¸¸ã«3è¡Œã®å¿…é ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼›Qã‚­ãƒ¼ã§å¿…ãšç”»åƒç”Ÿæˆï¼›angles.jsonã¯å¤‰æ›´ã—ãªã„ã€‚
  ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯phrases.jsonã®æ–‡è¨€ã®ã¿å‚ç…§ã—ã€å†…éƒ¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ã“ã“ã§è¨­å®šã—ã¦UIã‚’æ±šã•ãªã„ã€‚

state:
  angle: null        # 0~9ï¼›0=å‰å›ã‚’ä½¿ç”¨/ã‚¹ã‚­ãƒƒãƒ—
  bg: null           # Aï½E ã¾ãŸã¯åœ°åæ–‡å­—åˆ—
  ready: true        # å¤šé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ï¼›falseã¯ç”Ÿæˆä¸­ã‚’æ„å‘³ã™ã‚‹

variables:
  # è§’åº¦ â†’ å†…éƒ¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯éè¡¨ç¤ºï¼‰
  angle_prompts:
    "0": ""
    "1": "ã‚«ãƒ¡ãƒ©å·¦ã«45Â°å›è»¢",
    "2": "ã‚«ãƒ¡ãƒ©å·¦ã«90Â°å›è»¢",
    "3": "ã‚«ãƒ¡ãƒ©å·¦ã«135Â°å›è»¢ï¼ˆã•ã‚‰ã«å´é¢å¯„ã‚Šï¼‰",
    "4": "ã‚«ãƒ¡ãƒ©èƒŒé¢ï¼ˆç´„180Â°ï¼‰",
    "5": "ã‚«ãƒ¡ãƒ©å³ã«45Â°å›è»¢",
    "6": "ã‚«ãƒ¡ãƒ©å³ã«90Â°å›è»¢",
    "7": "ã‚«ãƒ¡ãƒ©å³ã«135Â°å›è»¢ï¼ˆã•ã‚‰ã«å´é¢å¯„ã‚Šï¼‰",
    "8": "ä½ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸Šã’ï¼‰",
    "9": "é«˜ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸‹ã‚ã—ï¼‰"
  # åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ï¼šã‚«ãƒ¡ãƒ©ãƒãƒ³å†™ã‚Šè¾¼ã¿ç¦æ­¢ã€æ‰‹æŒã¡ã‚«ãƒ¡ãƒ©ç¦æ­¢ãªã©
  guardrails: >
    clean portrait framing, no photographer or camera visible in frame,
    natural daylight color, realistic skin tones, depth of field, bokeh background

entry:
  say:
    - "{ui.first_shot_hint}"
    - "{angles.menu_title}ï¼š"0": "ã‚¹ã‚­ãƒƒãƒ—",
      "1": "ã‚«ãƒ¡ãƒ©å·¦45Â°",
      "2": "ã‚«ãƒ¡ãƒ©å·¦90Â°",
      "3": "ã‚«ãƒ¡ãƒ©å·¦135Â°ï¼ˆã•ã‚‰ã«å´é¢å¯„ã‚Šï¼‰",
      "4": "ã‚«ãƒ¡ãƒ©èƒŒé¢ï¼ˆç´„180Â°ï¼‰",
      "5": "ã‚«ãƒ¡ãƒ©å³45Â°",
      "6": "ã‚«ãƒ¡ãƒ©å³90Â°",
      "7": "ã‚«ãƒ¡ãƒ©å³135Â°ï¼ˆã•ã‚‰ã«å´é¢å¯„ã‚Šï¼‰",
      "8": "ä½ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸Šã’ï¼‰",
      "9": "é«˜ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸‹ã‚ã—ï¼‰"
    - "{backgrounds_ui.menu_title}\n{backgrounds_ui.prefix}\n{backgrounds_ui.fallback_note}"

routes:
  # è§’åº¦ / èƒŒæ™¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼
  - when: "input in ['1','ï¼’', 'è§’åº¦', 'é¸è§’åº¦']"
    goto: angle_menu
  - when: "input in ['2','ï¼’', 'èƒŒæ™¯', 'é¸èƒŒæ™¯']"
    goto: bg_menu
  # è§’åº¦é¸æŠï¼ˆ0~9ï¼‰
  - when: "input matches '^[0-9]$'"
    set:
      angle: "{{ input }}"
    say:
      - "è§’åº¦è¨­å®šå®Œäº†ï½ {{ angles.labels[input] }}ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  # èƒŒæ™¯é¸æŠï¼ˆAï½E ã¾ãŸã¯åœ°åï¼‰
  - when: "input matches '^[A-Ea-e0]$'"
    set:
      bg: "{{ input | upper }}"
    say:
      - "èƒŒæ™¯è¨­å®šå®Œäº†ï½ {{ input | upper }}ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  - when: "input matches '^[^0-9A-Ea-e].{0,40}$'"
    set:
      bg: "{{ input }}"
    say:
      - "èƒŒæ™¯è¨­å®šå®Œäº†ï½ã€Œ{{ input }}ã€ã€‚{ui.after_adjust_hint}"
    goto: wait_shutter
  # ã‚·ãƒ£ãƒƒã‚¿ãƒ¼
  - when: "input in ['q','Q','å¿«é–€','æ‹ç…§']"
    goto: shutter

blocks:
  angle_menu:
    say:
      - "{angles.menu_title}ï¼š"
      - ""0": "ã‚¹ã‚­ãƒƒãƒ—",
      "1": "ã‚«ãƒ¡ãƒ©å·¦45Â°",
      "2": "ã‚«ãƒ¡ãƒ©å·¦90Â°",
      "3": "ã‚«ãƒ¡ãƒ©å·¦135Â°ï¼ˆã•ã‚‰ã«å´é¢å¯„ã‚Šï¼‰",
      "4": "ã‚«ãƒ¡ãƒ©èƒŒé¢ï¼ˆç´„180Â°ï¼‰",
      "5": "ã‚«ãƒ¡ãƒ©å³45Â°",
      "6": "ã‚«ãƒ¡ãƒ©å³90Â°",
      "7": "ã‚«ãƒ¡ãƒ©å³135Â°ï¼ˆã•ã‚‰ã«å´é¢å¯„ã‚Šï¼‰",
      "8": "ä½ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸Šã’ï¼‰",
      "9": "é«˜ã‚¢ãƒ³ã‚°ãƒ«ï¼ˆè¦‹ä¸‹ã‚ã—ï¼‰"
      - "ğŸ‘‰ 0ï½9ã‚’å…¥åŠ›ã—ã¦è§’åº¦ã‚’é¸æŠã€ã¾ãŸã¯Qã§æ’®å½±"
    return: true

  bg_menu:
    say:
      - "{backgrounds_ui.menu_title}"
      - "{backgrounds_ui.prefix}"
      - "{backgrounds_ui.fallback_note}"
      - "ğŸ‘‰ Aï½Eã‚’å…¥åŠ›ã—ã¦èƒŒæ™¯ã‚’é¸æŠã€ã¾ãŸã¯åœ°åã‚’å…¥åŠ›ã€ã¾ãŸã¯Qã§æ’®å½±"
    return: true

  wait_shutter:
    say:
      - "{ui.direct_q_hint}"
    return: true

  shutter:
    guard:
      - "state.ready == true"
    set:
      ready: false
    do:
      # ã“ã“ã§æ—¢å­˜ã®ç”»åƒç”Ÿæˆé–¢æ•°ã¨é€£æºï¼ˆä¾‹ï¼‰ï¼šgenerate_image(prompt=...)
      - call: generate_image
        with:
          prompt: |
            {{ variables.guardrails }}.
            {{ variables.angle_prompts[state.angle or '0'] }}
            {{ 'background at ' + state.bg if state.bg else '' }}
    composition:
            # âœ… æ¯”ç‡å›ºå®šï¼š60% ç¸¦é•· 1024x1536ï¼›30% æ¨ªé•· 1536x1024ï¼ˆ1:1ã¯ç¦æ­¢ï¼‰
            output_size: "{{ '1024x1536' if random() < 0.6 else '1536x1024' }}"
            # âœ… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ï¼šè‡ªç”±ãªãƒãƒ¼ã‚ºã€é ãã‚’è¦‹ã‚‹ã€åŒã˜ã‚·ãƒ¼ãƒ³ã§ç•°ãªã‚‹ã‚«ãƒ¡ãƒ©ä½ç½®ã€æ­£æ–¹å½¢ç¦æ­¢
            camera_prompt: >
              {{ random(@kb.rules.ca) }}ï¼›
              è‡ªç”±ãªãƒãƒ¼ã‚¸ãƒ³ã‚°ã€è‡ªç„¶ãªã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã€åŒã˜ã‚·ãƒ¼ãƒ³å†…ã§ç•°ãªã‚‹ã‚«ãƒ¡ãƒ©ä½ç½®ã€ã‚«ãƒ¡ãƒ©ã®å¾®ç§»å‹•ï¼ˆå‰å¾Œï¼å·¦å³ï¼ä¸Šä¸‹ã«è»½ãå¤‰åŒ–ï¼‰ï¼›
              ä¸»äººå…¬ã¯é ãã‚’è¦‹ã‚‹ã‹ã€ãƒ¬ãƒ³ã‚ºã‚’å¤–ã—ã¦ã‚‚OKã€è¡¨æƒ…ã¯è‡ªç„¶ã«ï¼›
              æ­£æ–¹å½¢æ§‹å›³ã¯ç¦æ­¢ï¼ˆno square / no 1:1ï¼‰ï¼›
              ç¸¦æ¨ªæ¯”ã¯portraitã¾ãŸã¯landscapeã‚’ç¶­æŒã€1:1ã¯é¿ã‘ã‚‹ï¼›
              æ˜ åƒã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ†ãƒªãƒ³ã‚°æ€§ã‚’ä¿ã¡ã€é‡è¤‡ã‚·ãƒ§ãƒƒãƒˆã‚’é¿ã‘ã€ç©ºé–“ã®ä¸€è²«æ€§ã‚’ç¶­æŒã€‚
     background_location:
            mode: select_from_pool
            region_hint: Taiwan
            require_match: true
            fallback_pool: "@kb.backgrounds.pool"
            randomize: true          
    say:
      - "{ui.after_shot_hint}"
    set:
      ready: true
    return: true
