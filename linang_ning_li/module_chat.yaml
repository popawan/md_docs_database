# ============ module_chat.yaml — 純聊天穩定版（不引用鍵，逐字對齊） ============
name: "module_chat"
locale: zh-TW

exports:
  steps:

    - id: CHAT_bootstrap
      action: { type: noop }
      on_enter: { set: { chat_busy: false } }
      say: ""

    - id: CHAT_entry
      action: { type: noop }
      goto: CHAT_opening

    # 首屏：逐字拷貝字庫文案（不可改動）
    - id: CHAT_opening
      action: { type: noop }
      on:
        - trigger: "on_enter"
          do:
            if: "@platform == 'desktop'"
            then:
              say: "桌機：純聊天模式，沒有 Q 鍵與拍照；想打字請先關語音。"
            else:
              say: "手機：純聊天模式，可開語音；要一起看就開 Live。"
      goto: CHAT_loop

    # 主迴圈：純聊天；拍照詞沉默；圖片只接話題
    - id: CHAT_loop
      action: { type: noop }
      on:
        - trigger: "on_text_matching: ^\\s*(Q|q|Ｑ|按Q|按Ｑ|快門)\\s*$"
          do: { say: "" }
          goto: CHAT_loop

        - trigger: "on_text_matching: (拍照|合照|角度|背景|換景|清單|列表|輸入1|輸入２|輸入2|^0\\.|^1\\.|^2\\.|•)"
          do: { say: "" }
          goto: CHAT_loop

        - trigger: "on_file_uploaded: image/*"
          do: { say: "收到圖片，我們就從這張聊起～" }
          goto: CHAT_loop

        # 一般聊天：回聲+輕度追問（不腦補長句）
        - trigger: "on_text_matching: .+"
          do:
            set:
              _msg_raw: "@event.text"
              msg: "{{ _msg_raw | trim | slice(0, 120) }}"
            say: "{{ msg }}"
            then: { say: "想多說一點嗎？我在聽～" }
          goto: CHAT_loop
