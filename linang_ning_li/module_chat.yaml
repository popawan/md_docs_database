module: module_chat
state:
  mode_chat: false
  chosen_bg: null
  chat_loc_ok: false

engine_subjects: &CHAT_SUBJ
  - { id: ningli,
      reference: "@kb.identity.reference_image",
      identity_lock: true, identity_strict_mode: true,
      identity_weight: "@kb.identity.identity_weight",
      face_strictness: "@kb.identity.face_strictness",
      gender: female, glasses_required: true }

engine_comp: &CHAT_COMP
  output_size: "@kb.layout_rules.default_portrait"
  camera_prompt: "50mm; natural light; waist_up"

steps:
  - id: CHAT_on
    trigger: "on_text_matching: ^\\s*(èŠå¤©æ‹|èŠå¤©æ‹ç…§|èŠå¤©æ¨¡å¼)\\s*$"
    when: "!$busy"
    do:
      set: { mode_chat: true, chat_loc_ok: false, chosen_bg: null }
      say: "{{ @kb.phrases.chat_photo.ask_location or 'ä½ æƒ³æŠŠæˆ‘æ‹åœ¨å“ªè£¡å‘¢ï¼Ÿ' }}"

  - id: CHAT_loc_free
    trigger: "on_text_matching: ^\\s*(?:åœ¨)?([\\u4e00-\\u9fa5A-Za-z0-9Â·\\-ï¼¿â€”\\s]{2,})\\s*$"
    when: "!$busy && mode_chat && !chat_loc_ok"
    do:
      set: { chosen_bg: "{{ $1.strip() }}", chat_loc_ok: true }
      say: "{{ (@kb.phrases.chat_photo.confirm_location or 'å¥½ï½é‚£æˆ‘å€‘å°±æ‹åœ¨ã€Œ{{chosen_bg}}ã€ï¼Œæº–å‚™å¥½æŒ‰Qæ‹ğŸ“·').replace('{{chosen_bg}}', chosen_bg) }}"

  - id: CHAT_shutter
    trigger: "on_text_matching: ^\\s*(?:[Qqï¼±ï½‘]|å¿«é–€|æ‹|æ‹ç…§|/q)\\s*$"
    when: "mode_chat"
    action:
      type: image
      operationId: system.compose
      parameters:
        subjects: *CHAT_SUBJ
        background_location:
          prefer: "{{ chosen_bg }}"
          mode: select_from_pool_or_name_match
          region_hint: Taiwan
          require_match: false
          fallback_pool: []
          randomize: false
        composition: *CHAT_COMP
    on_success: { set: { busy: false }, say: "{{ @kb.phrases.greetings[2] or 'æ‹å¥½äº†ğŸ“·' }} æˆ‘å€‘ç¹¼çºŒèŠï½æƒ³å†æ‹å°±æŒ‰ã€Qã€ã€‚" }
    on_failure: { set: { busy: false }, say: "{{ @kb.phrases.errors.compose_fail or 'é€™æ¬¡æ²’æ‹æˆåŠŸğŸ’¦ å†æŒ‰ã€Qã€è©¦ä¸€æ¬¡å§' }}" }

  - id: CHAT_off
    trigger: "on_text_matching: ^\\s*(çµæŸèŠå¤©æ‹|é€€å‡ºèŠå¤©æ‹|é—œé–‰èŠå¤©æ‹)\\s*$"
    when: "!$busy"
    do: { set: { mode_chat: false, chat_loc_ok: false, chosen_bg: null }, say: "å·²é—œé–‰èŠå¤©æ‹ï½" }

